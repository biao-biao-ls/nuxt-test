<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MutationObserver ç›‘å¬æœºåˆ¶æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button-group {
            margin: 15px 0;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .status-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .log-output {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .iframe-container {
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .iframe-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            font-weight: bold;
        }
        .mock-iframe {
            width: 100%;
            height: 400px;
            border: none;
            background-color: white;
        }
        .performance-info {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
        }
        .performance-info h4 {
            margin-top: 0;
            color: #155724;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .comparison-table .advantage {
            color: #28a745;
            font-weight: bold;
        }
        .comparison-table .disadvantage {
            color: #dc3545;
        }
        .observer-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .observer-active {
            background-color: #d4edda;
            color: #155724;
        }
        .observer-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MutationObserver ç›‘å¬æœºåˆ¶æµ‹è¯•</h1>
        
        <div class="performance-info">
            <h4>ğŸš€ æ€§èƒ½ä¼˜åŠ¿</h4>
            <p>ä½¿ç”¨ MutationObserver æ›¿ä»£å®šæ—¶å™¨ç›‘å¬ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>å®šæ—¶å™¨ (setInterval)</th>
                        <th>MutationObserver</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>æ€§èƒ½å½±å“</td>
                        <td class="disadvantage">æŒç»­æ¶ˆè€— CPUï¼Œæ¯ 500ms æ‰§è¡Œä¸€æ¬¡</td>
                        <td class="advantage">äº‹ä»¶é©±åŠ¨ï¼Œåªåœ¨ DOM å˜åŒ–æ—¶è§¦å‘</td>
                    </tr>
                    <tr>
                        <td>å“åº”é€Ÿåº¦</td>
                        <td class="disadvantage">æœ€å¤šå»¶è¿Ÿ 500ms</td>
                        <td class="advantage">å®æ—¶å“åº”ï¼Œå‡ ä¹æ— å»¶è¿Ÿ</td>
                    </tr>
                    <tr>
                        <td>èµ„æºæ¶ˆè€—</td>
                        <td class="disadvantage">æŒç»­å ç”¨å†…å­˜å’Œ CPU</td>
                        <td class="advantage">ä½èµ„æºæ¶ˆè€—ï¼ŒæŒ‰éœ€è§¦å‘</td>
                    </tr>
                    <tr>
                        <td>ç²¾ç¡®æ€§</td>
                        <td class="disadvantage">å¯èƒ½é”™è¿‡å¿«é€Ÿå˜åŒ–</td>
                        <td class="advantage">æ•è·æ‰€æœ‰ DOM å˜åŒ–</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ MutationObserver çŠ¶æ€ç›‘æ§</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkObserverSupport()">æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ</button>
                <button class="btn btn-info" onclick="testBasicObserver()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
                <button class="btn btn-success" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
                <button class="btn btn-warning" onclick="checkIframeAccess()">æ£€æŸ¥ iframe è®¿é—®</button>
            </div>
            <div id="observerStatus" class="status-display">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥ MutationObserver çŠ¶æ€...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” iframe ç›‘å¬æµ‹è¯•</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="createTestIframe()">åˆ›å»ºæµ‹è¯• iframe</button>
                <button class="btn btn-success" onclick="addChatBodyContent()">æ·»åŠ  #chat-body-content</button>
                <button class="btn btn-info" onclick="addVisitorMessage()">æ·»åŠ  .visitor-message</button>
                <button class="btn btn-danger" onclick="removeTestIframe()">ç§»é™¤æµ‹è¯• iframe</button>
            </div>
            
            <div class="iframe-container">
                <div class="iframe-header">
                    æµ‹è¯•åŒºåŸŸ - è§‚å¯Ÿå™¨çŠ¶æ€: 
                    <span id="observerStatusIndicator" class="observer-status observer-inactive">æœªæ¿€æ´»</span>
                </div>
                <div id="iframeTestArea" style="min-height: 200px; padding: 20px; background: #f9f9f9;">
                    <p>è¿™é‡Œå°†åŠ¨æ€åˆ›å»ºå’Œæµ‹è¯• iframe å…ƒç´ </p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ€§èƒ½å¯¹æ¯”æµ‹è¯•</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startPerformanceTest()">å¼€å§‹æ€§èƒ½æµ‹è¯•</button>
                <button class="btn btn-warning" onclick="stopPerformanceTest()">åœæ­¢æµ‹è¯•</button>
                <button class="btn btn-info" onclick="clearPerformanceResults()">æ¸…ç©ºç»“æœ</button>
            </div>
            <div id="performanceResults" class="status-display">ç‚¹å‡»"å¼€å§‹æ€§èƒ½æµ‹è¯•"æŸ¥çœ‹å¯¹æ¯”ç»“æœ...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
            <div class="button-group">
                <button class="btn btn-info" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn btn-warning" onclick="toggleAutoScroll()">åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
            </div>
            <div id="logOutput" class="log-output">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
        </div>
    </div>

    <script>
        let autoScroll = true;
        let logContainer;
        let performanceTestInterval;
        let observerTestCount = 0;
        let timerTestCount = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logOutput');
            log('é¡µé¢åŠ è½½å®Œæˆï¼ŒMutationObserver ç›‘å¬æœºåˆ¶æµ‹è¯•å¼€å§‹...');
            
            // æ¨¡æ‹Ÿ QuickChat ç¯å¢ƒ
            setupMockQuickChat();
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (logContainer) {
                logContainer.textContent += logMessage + '\n';
                if (autoScroll) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }
            console.log(logMessage);
        }

        // è®¾ç½®æ¨¡æ‹Ÿ QuickChat ç¯å¢ƒ
        function setupMockQuickChat() {
            log('è®¾ç½®æ¨¡æ‹Ÿ QuickChat ç¯å¢ƒ...');
            
            // æ¨¡æ‹Ÿ QuickChat API
            window.quickChatApi = {
                customHeader: {
                    mount: function(callback) {
                        log('customHeader.mount è¢«è°ƒç”¨');
                        const container = document.createElement('div');
                        container.id = 'mock-header-container';
                        container.style.cssText = 'border: 2px solid #28a745; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    }
                },
                customLeftBar: {
                    mount: function(callback) {
                        log('customLeftBar.mount è¢«è°ƒç”¨');
                        const container = document.createElement('div');
                        container.id = 'mock-leftbar-container';
                        container.style.cssText = 'border: 2px solid #17a2b8; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    },
                    setIsShow: function(show) {
                        log(`customLeftBar.setIsShow(${show}) è¢«è°ƒç”¨`);
                        const container = document.getElementById('mock-leftbar-container');
                        if (container) {
                            container.style.display = show ? 'block' : 'none';
                        }
                    }
                },
                customFooter: {
                    mount: function(callback) {
                        log('customFooter.mount è¢«è°ƒç”¨');
                        const container = document.createElement('div');
                        container.id = 'mock-footer-container';
                        container.style.cssText = 'border: 2px solid #ffc107; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    }
                },
                emitGetAllOperatorStatus: function(ids) {
                    log(`emitGetAllOperatorStatus è¢«è°ƒç”¨ï¼Œå®¢æœIDs: ${JSON.stringify(ids)}`);
                },
                switchChat: function(id) {
                    log(`switchChat è¢«è°ƒç”¨ï¼Œå®¢æœID: ${id}`);
                }
            };

            window.quickEmitter = {
                on: function(event, callback) {
                    log(`ç›‘å¬äº‹ä»¶: ${event}`);
                },
                off: function(event) {
                    log(`å–æ¶ˆç›‘å¬äº‹ä»¶: ${event}`);
                },
                emit: function(event, data) {
                    log(`è§¦å‘äº‹ä»¶: ${event}, æ•°æ®: ${JSON.stringify(data)}`);
                }
            };

            // æ¨¡æ‹Ÿ QuickChat åˆå§‹åŒ–
            setTimeout(() => {
                log('æ¨¡æ‹Ÿ QuickChat åˆå§‹åŒ–å®Œæˆ');
                if (window.quickChatReadyHook) {
                    window.quickChatReadyHook();
                }
            }, 1000);
        }

        // æ£€æŸ¥æµè§ˆå™¨å¯¹ MutationObserver çš„æ”¯æŒ
        function checkObserverSupport() {
            log('æ£€æŸ¥æµè§ˆå™¨å¯¹ MutationObserver çš„æ”¯æŒ...');
            
            const support = {
                MutationObserver: typeof MutationObserver !== 'undefined',
                WebKitMutationObserver: typeof WebKitMutationObserver !== 'undefined',
                MozMutationObserver: typeof MozMutationObserver !== 'undefined'
            };

            let statusText = 'æµè§ˆå™¨æ”¯æŒæ£€æŸ¥ç»“æœ:\n';
            statusText += `- MutationObserver: ${support.MutationObserver ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}\n`;
            statusText += `- WebKitMutationObserver: ${support.WebKitMutationObserver ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}\n`;
            statusText += `- MozMutationObserver: ${support.MozMutationObserver ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}\n`;
            
            if (support.MutationObserver) {
                statusText += '\nâœ… æµè§ˆå™¨å®Œå…¨æ”¯æŒ MutationObserver API';
                log('âœ… æµè§ˆå™¨æ”¯æŒ MutationObserver');
            } else {
                statusText += '\nâŒ æµè§ˆå™¨ä¸æ”¯æŒ MutationObserver API';
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ MutationObserver');
            }

            document.getElementById('observerStatus').textContent = statusText;
        }

        // æµ‹è¯•åŸºç¡€ MutationObserver åŠŸèƒ½
        function testBasicObserver() {
            log('æµ‹è¯•åŸºç¡€ MutationObserver åŠŸèƒ½...');
            
            if (typeof MutationObserver === 'undefined') {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ MutationObserver');
                return;
            }

            // åˆ›å»ºæµ‹è¯•å…ƒç´ 
            const testDiv = document.createElement('div');
            testDiv.id = 'basic-observer-test';
            testDiv.style.cssText = 'border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f0f0f0;';
            testDiv.innerHTML = '<p>åŸºç¡€æµ‹è¯•å®¹å™¨</p>';
            document.getElementById('observerStatus').appendChild(testDiv);

            let changeCount = 0;
            const observer = new MutationObserver((mutations) => {
                changeCount++;
                log(`âœ… MutationObserver è§¦å‘ #${changeCount}ï¼Œæ£€æµ‹åˆ° ${mutations.length} ä¸ªå˜åŒ–`);
                
                mutations.forEach((mutation, index) => {
                    log(`  å˜åŒ– ${index + 1}: ${mutation.type}, æ·»åŠ èŠ‚ç‚¹: ${mutation.addedNodes.length}, ç§»é™¤èŠ‚ç‚¹: ${mutation.removedNodes.length}`);
                });

                if (changeCount >= 3) {
                    observer.disconnect();
                    log('âœ… åŸºç¡€æµ‹è¯•å®Œæˆï¼Œè§‚å¯Ÿå™¨å·²æ–­å¼€');
                    setTimeout(() => {
                        testDiv.remove();
                    }, 2000);
                }
            });

            observer.observe(testDiv, {
                childList: true,
                subtree: true,
                attributes: true
            });

            // è§¦å‘ä¸€ç³»åˆ—å˜åŒ–
            setTimeout(() => {
                const newP = document.createElement('p');
                newP.textContent = 'æ–°å¢æ®µè½ 1';
                testDiv.appendChild(newP);
            }, 500);

            setTimeout(() => {
                const newP = document.createElement('p');
                newP.textContent = 'æ–°å¢æ®µè½ 2';
                testDiv.appendChild(newP);
            }, 1000);

            setTimeout(() => {
                testDiv.setAttribute('data-test', 'modified');
            }, 1500);

            log('åŸºç¡€æµ‹è¯•å·²å¯åŠ¨ï¼Œå°†åœ¨ 3 ç§’å†…å®Œæˆ');
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        function checkSystemStatus() {
            log('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            if (window.debugQuickChat && window.debugQuickChat.testMutationObserver) {
                const result = window.debugQuickChat.testMutationObserver();
                log(`MutationObserver æµ‹è¯•ç»“æœ: ${result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`);
            } else {
                log('debugQuickChat.testMutationObserver æ–¹æ³•ä¸å¯ç”¨');
            }

            if (window.debugQuickChat && window.debugQuickChat.getSystemStatus) {
                const status = window.debugQuickChat.getSystemStatus();
                log(`ç³»ç»ŸçŠ¶æ€: ${JSON.stringify(status, null, 2)}`);
            }
        }

        // æ£€æŸ¥ iframe è®¿é—®æƒé™
        function checkIframeAccess() {
            log('æ£€æŸ¥ iframe è®¿é—®æƒé™...');
            
            if (window.debugQuickChat && window.debugQuickChat.checkIframeAccess) {
                const result = window.debugQuickChat.checkIframeAccess();
                log(`iframe è®¿é—®æ£€æŸ¥ç»“æœ: ${JSON.stringify(result, null, 2)}`);
                
                let statusText = 'iframe è®¿é—®æƒé™æ£€æŸ¥:\n';
                statusText += `- å¯è®¿é—®: ${result.accessible ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
                if (!result.accessible) {
                    statusText += `- åŸå› : ${result.reason}\n`;
                } else {
                    statusText += `- contentDocument: ${result.contentDocument ? 'âœ…' : 'âŒ'}\n`;
                    statusText += `- chatBodyContent: ${result.chatBodyContent ? 'âœ…' : 'âŒ'}\n`;
                    statusText += `- readyState: ${result.readyState}\n`;
                }
                
                document.getElementById('observerStatus').textContent = statusText;
            } else {
                log('debugQuickChat.checkIframeAccess æ–¹æ³•ä¸å¯ç”¨');
            }
        }

        // åˆ›å»ºæµ‹è¯• iframe
        function createTestIframe() {
            log('åˆ›å»ºæµ‹è¯• iframe...');
            
            // ç§»é™¤ç°æœ‰çš„æµ‹è¯• iframe
            const existing = document.getElementById('quick-chat-iframe');
            if (existing) {
                existing.remove();
            }

            const iframe = document.createElement('iframe');
            iframe.id = 'quick-chat-iframe';
            iframe.style.cssText = 'width: 100%; height: 300px; border: 1px solid #ddd;';
            
            // åˆ›å»º iframe å†…å®¹
            iframe.srcdoc = `
                <html>
                <head>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        #chat-body-content { border: 2px solid #007bff; padding: 15px; margin: 10px 0; background: #f8f9fa; }
                        .visitor-message { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #2196f3; }
                    </style>
                </head>
                <body>
                    <h3>QuickChat iframe æ¨¡æ‹Ÿ</h3>
                    <p>è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„èŠå¤©çª—å£ iframe</p>
                    <div id="placeholder">ç­‰å¾…æ·»åŠ  #chat-body-content...</div>
                </body>
                </html>
            `;

            document.getElementById('iframeTestArea').appendChild(iframe);
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateObserverStatus('active');
            
            log('æµ‹è¯• iframe å·²åˆ›å»º');
        }

        // æ·»åŠ  #chat-body-content
        function addChatBodyContent() {
            log('æ·»åŠ  #chat-body-content å…ƒç´ ...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (!iframe || !iframe.contentDocument) {
                log('âŒ iframe ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                return;
            }

            const chatBodyContent = iframe.contentDocument.createElement('div');
            chatBodyContent.id = 'chat-body-content';
            chatBodyContent.innerHTML = `
                <h4>èŠå¤©å†…å®¹åŒºåŸŸ</h4>
                <p>ç­‰å¾…è®¿å®¢æ¶ˆæ¯...</p>
            `;

            const placeholder = iframe.contentDocument.getElementById('placeholder');
            if (placeholder) {
                placeholder.replaceWith(chatBodyContent);
            } else {
                iframe.contentDocument.body.appendChild(chatBodyContent);
            }

            log('âœ… #chat-body-content å·²æ·»åŠ ');
        }

        // æ·»åŠ  .visitor-message
        function addVisitorMessage() {
            log('æ·»åŠ  .visitor-message å…ƒç´ ...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (!iframe || !iframe.contentDocument) {
                log('âŒ iframe ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                return;
            }

            const chatBodyContent = iframe.contentDocument.getElementById('chat-body-content');
            if (!chatBodyContent) {
                log('âŒ #chat-body-content ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ ');
                return;
            }

            const visitorMessage = iframe.contentDocument.createElement('div');
            visitorMessage.className = 'visitor-message';
            visitorMessage.innerHTML = `
                <strong>è®¿å®¢æ¶ˆæ¯ ${Date.now()}</strong><br>
                è¿™æ˜¯ä¸€æ¡æ¨¡æ‹Ÿçš„è®¿å®¢æ¶ˆæ¯ï¼Œåº”è¯¥è§¦å‘è‡ªå®šä¹‰å…ƒç´ åˆå§‹åŒ–
            `;

            chatBodyContent.appendChild(visitorMessage);
            
            log('âœ… .visitor-message å·²æ·»åŠ ï¼Œåº”è¯¥è§¦å‘ MutationObserver');
            
            // æ£€æŸ¥æ˜¯å¦è§¦å‘äº†åˆå§‹åŒ–
            setTimeout(() => {
                if (window.debugQuickChat && window.debugQuickChat.checkChatWindow) {
                    const result = window.debugQuickChat.checkChatWindow();
                    log(`èŠå¤©çª—å£æ£€æŸ¥ç»“æœ: ${result}`);
                }
            }, 500);
        }

        // ç§»é™¤æµ‹è¯• iframe
        function removeTestIframe() {
            log('ç§»é™¤æµ‹è¯• iframe...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (iframe) {
                iframe.remove();
                log('âœ… æµ‹è¯• iframe å·²ç§»é™¤');
            } else {
                log('âŒ æµ‹è¯• iframe ä¸å­˜åœ¨');
            }
            
            updateObserverStatus('inactive');
        }

        // æ›´æ–°è§‚å¯Ÿå™¨çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateObserverStatus(status) {
            const indicator = document.getElementById('observerStatusIndicator');
            if (status === 'active') {
                indicator.textContent = 'å·²æ¿€æ´»';
                indicator.className = 'observer-status observer-active';
            } else {
                indicator.textContent = 'æœªæ¿€æ´»';
                indicator.className = 'observer-status observer-inactive';
            }
        }

        // å¼€å§‹æ€§èƒ½æµ‹è¯•
        function startPerformanceTest() {
            log('å¼€å§‹æ€§èƒ½å¯¹æ¯”æµ‹è¯•...');
            
            observerTestCount = 0;
            timerTestCount = 0;
            
            // åˆ›å»ºæµ‹è¯•å®¹å™¨
            const testContainer = document.createElement('div');
            testContainer.id = 'performance-test-container';
            testContainer.style.cssText = 'display: none;'; // éšè—ä»¥é¿å…å½±å“é¡µé¢
            document.body.appendChild(testContainer);

            // MutationObserver æµ‹è¯•
            const observerStartTime = performance.now();
            const observer = new MutationObserver((mutations) => {
                observerTestCount++;
                if (observerTestCount >= 100) {
                    const observerEndTime = performance.now();
                    const observerTime = observerEndTime - observerStartTime;
                    
                    observer.disconnect();
                    log(`âœ… MutationObserver æµ‹è¯•å®Œæˆ: ${observerTestCount} æ¬¡è§¦å‘ï¼Œè€—æ—¶ ${observerTime.toFixed(2)}ms`);
                    
                    // å¼€å§‹å®šæ—¶å™¨æµ‹è¯•
                    startTimerTest(testContainer);
                }
            });

            observer.observe(testContainer, { childList: true });

            // å¿«é€Ÿæ·»åŠ å…ƒç´ è§¦å‘ MutationObserver
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.textContent = `Test ${i}`;
                    testContainer.appendChild(div);
                }, i * 10);
            }
        }

        // å®šæ—¶å™¨æµ‹è¯•
        function startTimerTest(testContainer) {
            log('å¼€å§‹å®šæ—¶å™¨æµ‹è¯•...');
            
            const timerStartTime = performance.now();
            let checkCount = 0;
            
            const interval = setInterval(() => {
                checkCount++;
                timerTestCount++;
                
                // æ¨¡æ‹Ÿæ£€æŸ¥æ“ä½œ
                const children = testContainer.children.length;
                
                if (checkCount >= 100) {
                    const timerEndTime = performance.now();
                    const timerTime = timerEndTime - timerStartTime;
                    
                    clearInterval(interval);
                    log(`âœ… å®šæ—¶å™¨æµ‹è¯•å®Œæˆ: ${timerTestCount} æ¬¡æ£€æŸ¥ï¼Œè€—æ—¶ ${timerTime.toFixed(2)}ms`);
                    
                    // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                    showPerformanceResults(timerTime);
                    
                    // æ¸…ç†æµ‹è¯•å®¹å™¨
                    testContainer.remove();
                }
            }, 10);
        }

        // æ˜¾ç¤ºæ€§èƒ½æµ‹è¯•ç»“æœ
        function showPerformanceResults(timerTime) {
            const resultsDiv = document.getElementById('performanceResults');
            
            let results = 'æ€§èƒ½å¯¹æ¯”æµ‹è¯•ç»“æœ:\n\n';
            results += `MutationObserver:\n`;
            results += `- è§¦å‘æ¬¡æ•°: ${observerTestCount}\n`;
            results += `- å“åº”æ–¹å¼: äº‹ä»¶é©±åŠ¨ï¼Œå®æ—¶å“åº”\n`;
            results += `- èµ„æºæ¶ˆè€—: ä½ï¼Œä»…åœ¨ DOM å˜åŒ–æ—¶è§¦å‘\n\n`;
            
            results += `å®šæ—¶å™¨ (setInterval):\n`;
            results += `- æ£€æŸ¥æ¬¡æ•°: ${timerTestCount}\n`;
            results += `- æ€»è€—æ—¶: ${timerTime.toFixed(2)}ms\n`;
            results += `- å“åº”æ–¹å¼: å®šæœŸè½®è¯¢ï¼Œå¯èƒ½æœ‰å»¶è¿Ÿ\n`;
            results += `- èµ„æºæ¶ˆè€—: é«˜ï¼ŒæŒç»­å ç”¨ CPU\n\n`;
            
            results += `ç»“è®º:\n`;
            results += `âœ… MutationObserver åœ¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦ä¸Šéƒ½ä¼˜äºå®šæ—¶å™¨\n`;
            results += `âœ… æ¨èä½¿ç”¨ MutationObserver è¿›è¡Œ DOM å˜åŒ–ç›‘å¬`;
            
            resultsDiv.textContent = results;
            log('æ€§èƒ½å¯¹æ¯”æµ‹è¯•å®Œæˆ');
        }

        // åœæ­¢æ€§èƒ½æµ‹è¯•
        function stopPerformanceTest() {
            if (performanceTestInterval) {
                clearInterval(performanceTestInterval);
                performanceTestInterval = null;
                log('æ€§èƒ½æµ‹è¯•å·²åœæ­¢');
            }
        }

        // æ¸…ç©ºæ€§èƒ½æµ‹è¯•ç»“æœ
        function clearPerformanceResults() {
            document.getElementById('performanceResults').textContent = 'ç‚¹å‡»"å¼€å§‹æ€§èƒ½æµ‹è¯•"æŸ¥çœ‹å¯¹æ¯”ç»“æœ...';
            log('æ€§èƒ½æµ‹è¯•ç»“æœå·²æ¸…ç©º');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            log(`è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¼€å¯' : 'å…³é—­'}`);
        }
    </script>
</body>
</html>