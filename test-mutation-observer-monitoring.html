<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MutationObserver 监听机制测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button-group {
            margin: 15px 0;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .status-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .log-output {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .iframe-container {
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .iframe-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            font-weight: bold;
        }
        .mock-iframe {
            width: 100%;
            height: 400px;
            border: none;
            background-color: white;
        }
        .performance-info {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
        }
        .performance-info h4 {
            margin-top: 0;
            color: #155724;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .comparison-table .advantage {
            color: #28a745;
            font-weight: bold;
        }
        .comparison-table .disadvantage {
            color: #dc3545;
        }
        .observer-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .observer-active {
            background-color: #d4edda;
            color: #155724;
        }
        .observer-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MutationObserver 监听机制测试</h1>
        
        <div class="performance-info">
            <h4>🚀 性能优势</h4>
            <p>使用 MutationObserver 替代定时器监听，具有以下优势：</p>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>特性</th>
                        <th>定时器 (setInterval)</th>
                        <th>MutationObserver</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>性能影响</td>
                        <td class="disadvantage">持续消耗 CPU，每 500ms 执行一次</td>
                        <td class="advantage">事件驱动，只在 DOM 变化时触发</td>
                    </tr>
                    <tr>
                        <td>响应速度</td>
                        <td class="disadvantage">最多延迟 500ms</td>
                        <td class="advantage">实时响应，几乎无延迟</td>
                    </tr>
                    <tr>
                        <td>资源消耗</td>
                        <td class="disadvantage">持续占用内存和 CPU</td>
                        <td class="advantage">低资源消耗，按需触发</td>
                    </tr>
                    <tr>
                        <td>精确性</td>
                        <td class="disadvantage">可能错过快速变化</td>
                        <td class="advantage">捕获所有 DOM 变化</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3>🎯 MutationObserver 状态监控</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkObserverSupport()">检查浏览器支持</button>
                <button class="btn btn-info" onclick="testBasicObserver()">测试基础功能</button>
                <button class="btn btn-success" onclick="checkSystemStatus()">检查系统状态</button>
                <button class="btn btn-warning" onclick="checkIframeAccess()">检查 iframe 访问</button>
            </div>
            <div id="observerStatus" class="status-display">点击按钮检查 MutationObserver 状态...</div>
        </div>

        <div class="test-section">
            <h3>🔍 iframe 监听测试</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="createTestIframe()">创建测试 iframe</button>
                <button class="btn btn-success" onclick="addChatBodyContent()">添加 #chat-body-content</button>
                <button class="btn btn-info" onclick="addVisitorMessage()">添加 .visitor-message</button>
                <button class="btn btn-danger" onclick="removeTestIframe()">移除测试 iframe</button>
            </div>
            
            <div class="iframe-container">
                <div class="iframe-header">
                    测试区域 - 观察器状态: 
                    <span id="observerStatusIndicator" class="observer-status observer-inactive">未激活</span>
                </div>
                <div id="iframeTestArea" style="min-height: 200px; padding: 20px; background: #f9f9f9;">
                    <p>这里将动态创建和测试 iframe 元素</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 性能对比测试</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startPerformanceTest()">开始性能测试</button>
                <button class="btn btn-warning" onclick="stopPerformanceTest()">停止测试</button>
                <button class="btn btn-info" onclick="clearPerformanceResults()">清空结果</button>
            </div>
            <div id="performanceResults" class="status-display">点击"开始性能测试"查看对比结果...</div>
        </div>

        <div class="test-section">
            <h3>📊 实时日志</h3>
            <div class="button-group">
                <button class="btn btn-info" onclick="clearLog()">清空日志</button>
                <button class="btn btn-warning" onclick="toggleAutoScroll()">切换自动滚动</button>
            </div>
            <div id="logOutput" class="log-output">等待日志输出...</div>
        </div>
    </div>

    <script>
        let autoScroll = true;
        let logContainer;
        let performanceTestInterval;
        let observerTestCount = 0;
        let timerTestCount = 0;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logOutput');
            log('页面加载完成，MutationObserver 监听机制测试开始...');
            
            // 模拟 QuickChat 环境
            setupMockQuickChat();
        });

        // 日志函数
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (logContainer) {
                logContainer.textContent += logMessage + '\n';
                if (autoScroll) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }
            console.log(logMessage);
        }

        // 设置模拟 QuickChat 环境
        function setupMockQuickChat() {
            log('设置模拟 QuickChat 环境...');
            
            // 模拟 QuickChat API
            window.quickChatApi = {
                customHeader: {
                    mount: function(callback) {
                        log('customHeader.mount 被调用');
                        const container = document.createElement('div');
                        container.id = 'mock-header-container';
                        container.style.cssText = 'border: 2px solid #28a745; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    }
                },
                customLeftBar: {
                    mount: function(callback) {
                        log('customLeftBar.mount 被调用');
                        const container = document.createElement('div');
                        container.id = 'mock-leftbar-container';
                        container.style.cssText = 'border: 2px solid #17a2b8; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    },
                    setIsShow: function(show) {
                        log(`customLeftBar.setIsShow(${show}) 被调用`);
                        const container = document.getElementById('mock-leftbar-container');
                        if (container) {
                            container.style.display = show ? 'block' : 'none';
                        }
                    }
                },
                customFooter: {
                    mount: function(callback) {
                        log('customFooter.mount 被调用');
                        const container = document.createElement('div');
                        container.id = 'mock-footer-container';
                        container.style.cssText = 'border: 2px solid #ffc107; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    }
                },
                emitGetAllOperatorStatus: function(ids) {
                    log(`emitGetAllOperatorStatus 被调用，客服IDs: ${JSON.stringify(ids)}`);
                },
                switchChat: function(id) {
                    log(`switchChat 被调用，客服ID: ${id}`);
                }
            };

            window.quickEmitter = {
                on: function(event, callback) {
                    log(`监听事件: ${event}`);
                },
                off: function(event) {
                    log(`取消监听事件: ${event}`);
                },
                emit: function(event, data) {
                    log(`触发事件: ${event}, 数据: ${JSON.stringify(data)}`);
                }
            };

            // 模拟 QuickChat 初始化
            setTimeout(() => {
                log('模拟 QuickChat 初始化完成');
                if (window.quickChatReadyHook) {
                    window.quickChatReadyHook();
                }
            }, 1000);
        }

        // 检查浏览器对 MutationObserver 的支持
        function checkObserverSupport() {
            log('检查浏览器对 MutationObserver 的支持...');
            
            const support = {
                MutationObserver: typeof MutationObserver !== 'undefined',
                WebKitMutationObserver: typeof WebKitMutationObserver !== 'undefined',
                MozMutationObserver: typeof MozMutationObserver !== 'undefined'
            };

            let statusText = '浏览器支持检查结果:\n';
            statusText += `- MutationObserver: ${support.MutationObserver ? '✅ 支持' : '❌ 不支持'}\n`;
            statusText += `- WebKitMutationObserver: ${support.WebKitMutationObserver ? '✅ 支持' : '❌ 不支持'}\n`;
            statusText += `- MozMutationObserver: ${support.MozMutationObserver ? '✅ 支持' : '❌ 不支持'}\n`;
            
            if (support.MutationObserver) {
                statusText += '\n✅ 浏览器完全支持 MutationObserver API';
                log('✅ 浏览器支持 MutationObserver');
            } else {
                statusText += '\n❌ 浏览器不支持 MutationObserver API';
                log('❌ 浏览器不支持 MutationObserver');
            }

            document.getElementById('observerStatus').textContent = statusText;
        }

        // 测试基础 MutationObserver 功能
        function testBasicObserver() {
            log('测试基础 MutationObserver 功能...');
            
            if (typeof MutationObserver === 'undefined') {
                log('❌ 浏览器不支持 MutationObserver');
                return;
            }

            // 创建测试元素
            const testDiv = document.createElement('div');
            testDiv.id = 'basic-observer-test';
            testDiv.style.cssText = 'border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f0f0f0;';
            testDiv.innerHTML = '<p>基础测试容器</p>';
            document.getElementById('observerStatus').appendChild(testDiv);

            let changeCount = 0;
            const observer = new MutationObserver((mutations) => {
                changeCount++;
                log(`✅ MutationObserver 触发 #${changeCount}，检测到 ${mutations.length} 个变化`);
                
                mutations.forEach((mutation, index) => {
                    log(`  变化 ${index + 1}: ${mutation.type}, 添加节点: ${mutation.addedNodes.length}, 移除节点: ${mutation.removedNodes.length}`);
                });

                if (changeCount >= 3) {
                    observer.disconnect();
                    log('✅ 基础测试完成，观察器已断开');
                    setTimeout(() => {
                        testDiv.remove();
                    }, 2000);
                }
            });

            observer.observe(testDiv, {
                childList: true,
                subtree: true,
                attributes: true
            });

            // 触发一系列变化
            setTimeout(() => {
                const newP = document.createElement('p');
                newP.textContent = '新增段落 1';
                testDiv.appendChild(newP);
            }, 500);

            setTimeout(() => {
                const newP = document.createElement('p');
                newP.textContent = '新增段落 2';
                testDiv.appendChild(newP);
            }, 1000);

            setTimeout(() => {
                testDiv.setAttribute('data-test', 'modified');
            }, 1500);

            log('基础测试已启动，将在 3 秒内完成');
        }

        // 检查系统状态
        function checkSystemStatus() {
            log('检查系统状态...');
            
            if (window.debugQuickChat && window.debugQuickChat.testMutationObserver) {
                const result = window.debugQuickChat.testMutationObserver();
                log(`MutationObserver 测试结果: ${result ? '✅ 通过' : '❌ 失败'}`);
            } else {
                log('debugQuickChat.testMutationObserver 方法不可用');
            }

            if (window.debugQuickChat && window.debugQuickChat.getSystemStatus) {
                const status = window.debugQuickChat.getSystemStatus();
                log(`系统状态: ${JSON.stringify(status, null, 2)}`);
            }
        }

        // 检查 iframe 访问权限
        function checkIframeAccess() {
            log('检查 iframe 访问权限...');
            
            if (window.debugQuickChat && window.debugQuickChat.checkIframeAccess) {
                const result = window.debugQuickChat.checkIframeAccess();
                log(`iframe 访问检查结果: ${JSON.stringify(result, null, 2)}`);
                
                let statusText = 'iframe 访问权限检查:\n';
                statusText += `- 可访问: ${result.accessible ? '✅ 是' : '❌ 否'}\n`;
                if (!result.accessible) {
                    statusText += `- 原因: ${result.reason}\n`;
                } else {
                    statusText += `- contentDocument: ${result.contentDocument ? '✅' : '❌'}\n`;
                    statusText += `- chatBodyContent: ${result.chatBodyContent ? '✅' : '❌'}\n`;
                    statusText += `- readyState: ${result.readyState}\n`;
                }
                
                document.getElementById('observerStatus').textContent = statusText;
            } else {
                log('debugQuickChat.checkIframeAccess 方法不可用');
            }
        }

        // 创建测试 iframe
        function createTestIframe() {
            log('创建测试 iframe...');
            
            // 移除现有的测试 iframe
            const existing = document.getElementById('quick-chat-iframe');
            if (existing) {
                existing.remove();
            }

            const iframe = document.createElement('iframe');
            iframe.id = 'quick-chat-iframe';
            iframe.style.cssText = 'width: 100%; height: 300px; border: 1px solid #ddd;';
            
            // 创建 iframe 内容
            iframe.srcdoc = `
                <html>
                <head>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        #chat-body-content { border: 2px solid #007bff; padding: 15px; margin: 10px 0; background: #f8f9fa; }
                        .visitor-message { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #2196f3; }
                    </style>
                </head>
                <body>
                    <h3>QuickChat iframe 模拟</h3>
                    <p>这是一个模拟的聊天窗口 iframe</p>
                    <div id="placeholder">等待添加 #chat-body-content...</div>
                </body>
                </html>
            `;

            document.getElementById('iframeTestArea').appendChild(iframe);
            
            // 更新状态指示器
            updateObserverStatus('active');
            
            log('测试 iframe 已创建');
        }

        // 添加 #chat-body-content
        function addChatBodyContent() {
            log('添加 #chat-body-content 元素...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (!iframe || !iframe.contentDocument) {
                log('❌ iframe 不存在或无法访问');
                return;
            }

            const chatBodyContent = iframe.contentDocument.createElement('div');
            chatBodyContent.id = 'chat-body-content';
            chatBodyContent.innerHTML = `
                <h4>聊天内容区域</h4>
                <p>等待访客消息...</p>
            `;

            const placeholder = iframe.contentDocument.getElementById('placeholder');
            if (placeholder) {
                placeholder.replaceWith(chatBodyContent);
            } else {
                iframe.contentDocument.body.appendChild(chatBodyContent);
            }

            log('✅ #chat-body-content 已添加');
        }

        // 添加 .visitor-message
        function addVisitorMessage() {
            log('添加 .visitor-message 元素...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (!iframe || !iframe.contentDocument) {
                log('❌ iframe 不存在或无法访问');
                return;
            }

            const chatBodyContent = iframe.contentDocument.getElementById('chat-body-content');
            if (!chatBodyContent) {
                log('❌ #chat-body-content 不存在，请先添加');
                return;
            }

            const visitorMessage = iframe.contentDocument.createElement('div');
            visitorMessage.className = 'visitor-message';
            visitorMessage.innerHTML = `
                <strong>访客消息 ${Date.now()}</strong><br>
                这是一条模拟的访客消息，应该触发自定义元素初始化
            `;

            chatBodyContent.appendChild(visitorMessage);
            
            log('✅ .visitor-message 已添加，应该触发 MutationObserver');
            
            // 检查是否触发了初始化
            setTimeout(() => {
                if (window.debugQuickChat && window.debugQuickChat.checkChatWindow) {
                    const result = window.debugQuickChat.checkChatWindow();
                    log(`聊天窗口检查结果: ${result}`);
                }
            }, 500);
        }

        // 移除测试 iframe
        function removeTestIframe() {
            log('移除测试 iframe...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (iframe) {
                iframe.remove();
                log('✅ 测试 iframe 已移除');
            } else {
                log('❌ 测试 iframe 不存在');
            }
            
            updateObserverStatus('inactive');
        }

        // 更新观察器状态指示器
        function updateObserverStatus(status) {
            const indicator = document.getElementById('observerStatusIndicator');
            if (status === 'active') {
                indicator.textContent = '已激活';
                indicator.className = 'observer-status observer-active';
            } else {
                indicator.textContent = '未激活';
                indicator.className = 'observer-status observer-inactive';
            }
        }

        // 开始性能测试
        function startPerformanceTest() {
            log('开始性能对比测试...');
            
            observerTestCount = 0;
            timerTestCount = 0;
            
            // 创建测试容器
            const testContainer = document.createElement('div');
            testContainer.id = 'performance-test-container';
            testContainer.style.cssText = 'display: none;'; // 隐藏以避免影响页面
            document.body.appendChild(testContainer);

            // MutationObserver 测试
            const observerStartTime = performance.now();
            const observer = new MutationObserver((mutations) => {
                observerTestCount++;
                if (observerTestCount >= 100) {
                    const observerEndTime = performance.now();
                    const observerTime = observerEndTime - observerStartTime;
                    
                    observer.disconnect();
                    log(`✅ MutationObserver 测试完成: ${observerTestCount} 次触发，耗时 ${observerTime.toFixed(2)}ms`);
                    
                    // 开始定时器测试
                    startTimerTest(testContainer);
                }
            });

            observer.observe(testContainer, { childList: true });

            // 快速添加元素触发 MutationObserver
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.textContent = `Test ${i}`;
                    testContainer.appendChild(div);
                }, i * 10);
            }
        }

        // 定时器测试
        function startTimerTest(testContainer) {
            log('开始定时器测试...');
            
            const timerStartTime = performance.now();
            let checkCount = 0;
            
            const interval = setInterval(() => {
                checkCount++;
                timerTestCount++;
                
                // 模拟检查操作
                const children = testContainer.children.length;
                
                if (checkCount >= 100) {
                    const timerEndTime = performance.now();
                    const timerTime = timerEndTime - timerStartTime;
                    
                    clearInterval(interval);
                    log(`✅ 定时器测试完成: ${timerTestCount} 次检查，耗时 ${timerTime.toFixed(2)}ms`);
                    
                    // 显示对比结果
                    showPerformanceResults(timerTime);
                    
                    // 清理测试容器
                    testContainer.remove();
                }
            }, 10);
        }

        // 显示性能测试结果
        function showPerformanceResults(timerTime) {
            const resultsDiv = document.getElementById('performanceResults');
            
            let results = '性能对比测试结果:\n\n';
            results += `MutationObserver:\n`;
            results += `- 触发次数: ${observerTestCount}\n`;
            results += `- 响应方式: 事件驱动，实时响应\n`;
            results += `- 资源消耗: 低，仅在 DOM 变化时触发\n\n`;
            
            results += `定时器 (setInterval):\n`;
            results += `- 检查次数: ${timerTestCount}\n`;
            results += `- 总耗时: ${timerTime.toFixed(2)}ms\n`;
            results += `- 响应方式: 定期轮询，可能有延迟\n`;
            results += `- 资源消耗: 高，持续占用 CPU\n\n`;
            
            results += `结论:\n`;
            results += `✅ MutationObserver 在性能和响应速度上都优于定时器\n`;
            results += `✅ 推荐使用 MutationObserver 进行 DOM 变化监听`;
            
            resultsDiv.textContent = results;
            log('性能对比测试完成');
        }

        // 停止性能测试
        function stopPerformanceTest() {
            if (performanceTestInterval) {
                clearInterval(performanceTestInterval);
                performanceTestInterval = null;
                log('性能测试已停止');
            }
        }

        // 清空性能测试结果
        function clearPerformanceResults() {
            document.getElementById('performanceResults').textContent = '点击"开始性能测试"查看对比结果...';
            log('性能测试结果已清空');
        }

        // 清空日志
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
        }

        // 切换自动滚动
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            log(`自动滚动已${autoScroll ? '开启' : '关闭'}`);
        }
    </script>
</body>
</html>