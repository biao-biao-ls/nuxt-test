<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单选择器测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        #order-selector-container {
            position: relative;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>订单选择器测试</h1>
        <p>这是一个独立的测试页面，用于验证订单选择器功能。</p>
        
        <div>
            <button class="test-btn" onclick="showOrderSelector()">显示订单选择器</button>
            <button class="test-btn" onclick="hideOrderSelector()">隐藏订单选择器</button>
        </div>
        
        <div id="order-selector-container"></div>
    </div>

    <script type="module">
        // 模拟 QuickChat API
        window.quickChatApi = {
            sendMessage: (message) => {
                console.log('发送消息:', message);
                alert('消息已发送:\n' + message);
            }
        };

        // 导入订单选择器
        class OrderSelector {
            constructor() {
                this.state = {
                    isVisible: false,
                    isClosing: false,
                    activeName: 'Orders',
                    keyword: '',
                    cartList: [],
                    orderList: [],
                    cartPageNum: 1,
                    orderPageNum: 1,
                    cartListTotal: 0,
                    orderListTotal: 0,
                    orderListLoading: false,
                    pageSize: 12
                };
                this.container = null;
                this.onSendOrderCallback = null;
            }

            setOnSendOrderCallback(callback) {
                this.onSendOrderCallback = callback;
            }

            show() {
                if (this.state.isVisible) return;
                
                this.state.isVisible = true;
                this.state.isClosing = false;
                this.render();
                this.initList();
            }

            hide() {
                if (!this.state.isVisible) return;
                
                this.state.isClosing = true;
                this.render();
                
                setTimeout(() => {
                    this.state.isVisible = false;
                    this.state.isClosing = false;
                    if (this.container) {
                        this.container.innerHTML = '';
                    }
                }, 300);
            }

            mount(container) {
                this.container = container;
            }

            render() {
                if (!this.container) return;

                if (!this.state.isVisible) {
                    this.container.innerHTML = '';
                    return;
                }

                this.container.innerHTML = `
                    ${this.generateStyles()}
                    <div class="chat-popup" onclick="this.handleBackdropClick(event)">
                        <div class="chat-popup-container ${this.state.isClosing ? 'slide-down' : ''}">
                            <div class="chat-popup-cate">
                                <div class="chat-popup-header">
                                    <strong class="chat-popup-title">Please Select an Order</strong>
                                    <div class="chat-popup-close" onclick="window.orderSelector && window.orderSelector.hide()">×</div>
                                </div>
                                <div class="chat-search-wrapper">
                                    <div class="chat-search-input">
                                        <input type="text" 
                                               placeholder="Search order # or filename" 
                                               value="${this.state.keyword}"
                                               onkeydown="if(event.key==='Enter') window.orderSelector && window.orderSelector.handleSearch()"
                                               oninput="window.orderSelector && window.orderSelector.updateKeyword(this.value)">
                                        <div class="chat-search-btn" onclick="window.orderSelector && window.orderSelector.handleSearch()">Search</div>
                                    </div>
                                </div>
                                <div class="chat-tabs">
                                    <div class="tab-item ${this.state.activeName === 'Orders' ? 'active' : ''}" 
                                         onclick="window.orderSelector && window.orderSelector.switchTab('Orders')">Orders</div>
                                    <div class="tab-item ${this.state.activeName === 'Cart' ? 'active' : ''}" 
                                         onclick="window.orderSelector && window.orderSelector.switchTab('Cart')">Cart</div>
                                </div>
                            </div>
                            <div class="chat-order-list">
                                ${this.renderOrderList()}
                            </div>
                            ${this.state.orderListLoading ? '<div class="chat-loading">Loading...</div>' : ''}
                        </div>
                    </div>
                `;

                this.bindEvents();
            }

            renderOrderList() {
                if (this.state.activeName === 'Cart') {
                    return this.renderCartList();
                } else {
                    return this.renderOrdersList();
                }
            }

            renderCartList() {
                if (this.state.cartList.length === 0) {
                    return '<div class="chat-no-order">No items in cart</div>';
                }

                return this.state.cartList.map(item => `
                    <div class="chat-order-list-item">
                        <div class="chat-order-list-info">
                            ${this.renderOrderItem(item)}
                        </div>
                        <div class="chat-order-send">
                            <button class="send-btn" onclick="window.orderSelector && window.orderSelector.sendOrder('${item._orderCode}')">Send</button>
                        </div>
                    </div>
                `).join('');
            }

            renderOrdersList() {
                if (this.state.orderList.length === 0) {
                    return '<div class="chat-no-order">No orders found</div>';
                }

                return this.state.orderList.map(batch => `
                    <div class="chat-order-batch">
                        <span>${batch.batchNum}</span>
                        <span class="chat-order-batch-date">${this.getDateByBatchNum(batch.batchNum)}</span>
                    </div>
                    <div>
                        ${batch.orderSimpleVOS.map(item => `
                            <div class="chat-order-list-item">
                                <div class="chat-order-list-info">
                                    ${this.renderOrderItem(item)}
                                </div>
                                <div class="chat-order-send">
                                    <button class="send-btn" onclick="window.orderSelector && window.orderSelector.sendOrder('${item._orderCode}')">Send</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            }

            renderOrderItem(item) {
                return `
                    <div class="order-item">
                        <div class="order-image">
                            <img src="${item.imgUrl}" alt="${item.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iMjAiIHk9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5Ij5JTUc8L3RleHQ+PC9zdmc+'">
                        </div>
                        <div class="order-details">
                            <div class="order-title">${item.title}</div>
                            <div class="order-code">Order #: ${item._orderCode}</div>
                            <div class="order-amount">${item.orderAmount}</div>
                        </div>
                    </div>
                `;
            }

            generateStyles() {
                return `
                    <style>
                        .chat-popup {
                            position: fixed;
                            left: 0;
                            right: 0;
                            top: 0;
                            bottom: 0;
                            z-index: 9999;
                            background-color: rgba(0, 0, 0, 0.65);
                            display: flex;
                            align-items: flex-end;
                        }

                        .chat-popup-container {
                            height: 608px;
                            width: 100%;
                            background-color: #fff;
                            border-top-left-radius: 12px;
                            border-top-right-radius: 12px;
                            display: flex;
                            flex-direction: column;
                            animation: slideUp 0.3s ease-out;
                        }

                        .chat-popup-container.slide-down {
                            animation: slideDown 0.3s ease-out;
                        }

                        @keyframes slideUp {
                            from { transform: translateY(100%); }
                            to { transform: translateY(0); }
                        }

                        @keyframes slideDown {
                            from { transform: translateY(0); }
                            to { transform: translateY(100%); }
                        }

                        .chat-popup-cate {
                            padding: 12px 12px 0 12px;
                        }

                        .chat-popup-header {
                            line-height: 18px;
                            padding: 10px;
                            position: relative;
                        }

                        .chat-popup-title {
                            font-size: 16px;
                            font-weight: bold;
                        }

                        .chat-popup-close {
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            cursor: pointer;
                            width: 20px;
                            height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 18px;
                            color: #999;
                        }

                        .chat-search-wrapper {
                            position: relative;
                            margin-bottom: 12px;
                        }

                        .chat-search-input {
                            display: flex;
                            height: 34px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            overflow: hidden;
                        }

                        .chat-search-input input {
                            flex: 1;
                            height: 32px;
                            padding: 0 8px;
                            border: none;
                            outline: none;
                            font-size: 14px;
                        }

                        .chat-search-btn {
                            height: 32px;
                            line-height: 32px;
                            padding: 0 12px;
                            background-color: #444444;
                            color: white;
                            cursor: pointer;
                            font-size: 14px;
                        }

                        .chat-tabs {
                            display: flex;
                            border-bottom: 1px solid #e6eaf1;
                        }

                        .tab-item {
                            padding: 12px 16px;
                            cursor: pointer;
                            border-bottom: 2px solid transparent;
                            color: #666;
                        }

                        .tab-item.active {
                            color: #007bff;
                            border-bottom-color: #007bff;
                        }

                        .chat-order-list {
                            flex: 1;
                            overflow: auto;
                            padding: 12px;
                            font-size: 14px;
                        }

                        .chat-order-batch {
                            display: flex;
                            justify-content: space-between;
                            border-bottom: 1px solid #e6eaf1;
                            padding-bottom: 4px;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }

                        .chat-order-batch-date {
                            color: #999;
                            font-weight: normal;
                        }

                        .chat-order-list-item {
                            display: flex;
                            align-items: center;
                            margin-bottom: 15px;
                            padding: 8px;
                            border: 1px solid #f0f0f0;
                            border-radius: 8px;
                        }

                        .chat-order-list-info {
                            flex: 1;
                        }

                        .order-item {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        }

                        .order-image img {
                            width: 40px;
                            height: 40px;
                            object-fit: cover;
                            border-radius: 4px;
                        }

                        .order-details {
                            flex: 1;
                        }

                        .order-title {
                            font-weight: 500;
                            margin-bottom: 4px;
                            color: #333;
                        }

                        .order-code {
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 2px;
                        }

                        .order-amount {
                            font-size: 14px;
                            color: #007bff;
                            font-weight: 500;
                        }

                        .send-btn {
                            background-color: #007bff;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                        }

                        .send-btn:hover {
                            background-color: #0056b3;
                        }

                        .chat-no-order {
                            text-align: center;
                            color: #999;
                            padding: 40px 20px;
                        }

                        .chat-loading {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(255, 255, 255, 0.9);
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                        }
                    </style>
                `;
            }

            bindEvents() {
                const container = this.container?.querySelector('.chat-popup-container');
                if (container) {
                    container.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }

                const popup = this.container?.querySelector('.chat-popup');
                if (popup) {
                    popup.addEventListener('click', (e) => {
                        if (e.target === popup) {
                            this.hide();
                        }
                    });
                }
            }

            updateKeyword(keyword) {
                this.state.keyword = keyword;
            }

            handleSearch() {
                console.log('搜索:', this.state.keyword);
                // 重新加载数据
                this.initList();
            }

            switchTab(tabName) {
                this.state.activeName = tabName;
                this.render();
            }

            sendOrder(orderCode) {
                const allItems = [...this.state.cartList, ...this.state.orderList.flatMap(batch => batch.orderSimpleVOS)];
                const orderItem = allItems.find(item => item._orderCode === orderCode);
                
                if (orderItem && this.onSendOrderCallback) {
                    this.onSendOrderCallback(orderItem);
                    this.hide();
                }
            }

            initList() {
                this.getOrderList();
                this.getCartList();
            }

            async getOrderList() {
                this.state.orderListLoading = true;
                this.render();

                try {
                    const response = await this.mockOrderAPI();
                    this.state.orderListTotal = response.total;
                    const list = this.dealOrderList(response.list);
                    this.state.orderList = list; // 替换而不是追加
                } catch (error) {
                    console.error('获取订单数据失败:', error);
                }

                this.state.orderListLoading = false;
                this.render();
            }

            async getCartList() {
                try {
                    const response = await this.mockCartAPI();
                    this.state.cartListTotal = response.total;
                    const list = this.dealCartList(response.list);
                    this.state.cartList = list; // 替换而不是追加
                } catch (error) {
                    console.error('获取购物车数据失败:', error);
                }
                this.render();
            }

            async mockOrderAPI() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            total: 14209,
                            list: [
                                {
                                    batchNum: "W2025101311330202",
                                    createTime: null,
                                    orderSimpleVOS: [
                                        {
                                            batchNum: "W2025101311330202",
                                            orderCode: "Y11898-5011496A",
                                            businessId: 2753578,
                                            businessType: "order_pcb",
                                            title: "pcbwenjian2(Reorder)_Y11898",
                                            settleCurrency: "USD",
                                            orderAmount: 15.63,
                                            fileAccessId: "8665175429193543680",
                                            orderStatus: "inProduce",
                                            goodsAmount: 5
                                        }
                                    ]
                                },
                                {
                                    batchNum: "W2025101311230182",
                                    createTime: null,
                                    orderSimpleVOS: [
                                        {
                                            batchNum: "W2025101311230182",
                                            orderCode: "SMS2510133000010",
                                            businessId: 499851307639836673,
                                            businessType: "order_plate_metal",
                                            title: "1.STEP",
                                            settleCurrency: "USD",
                                            orderAmount: 8.22,
                                            fileAccessId: "8665284287446663168",
                                            orderStatus: "paid",
                                            goodsAmount: 1
                                        },
                                        {
                                            batchNum: "W2025101311230182",
                                            orderCode: "SMS2510133000011",
                                            businessId: 499851307639836674,
                                            businessType: "order_plate_metal",
                                            title: "3.STEP",
                                            settleCurrency: "USD",
                                            orderAmount: 82.43,
                                            fileAccessId: "8665284287446663169",
                                            orderStatus: "paid",
                                            goodsAmount: 1
                                        }
                                    ]
                                }
                            ]
                        });
                    }, 500);
                });
            }

            async mockCartAPI() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            total: 52,
                            list: [
                                {
                                    pcbGoods: {
                                        goodsCode: "Y11899",
                                        gerberFile: "12321321_Y11899",
                                        price: 10.53,
                                        quantity: 5,
                                        customerCode: "5011496A",
                                        technologyDiscernNum: "ac1babcbf7de432bbb94b16410e47f78"
                                    }
                                }
                            ]
                        });
                    }, 500);
                });
            }

            dealOrderList(list) {
                return list.map(pItem => ({
                    batchNum: pItem.batchNum,
                    createTime: pItem.createTime,
                    orderSimpleVOS: pItem.orderSimpleVOS.map((item) => ({
                        title: item.title,
                        _orderCode: item.orderCode,
                        orderCode: item.orderCode,
                        customerCode: '5011496A',
                        orderCount: item.goodsAmount,
                        batchNum: item.batchNum,
                        imgUrl: this.getOrderImageUrl(item),
                        orderAmount: `$${item.orderAmount}`,
                        businessType: item.businessType,
                        source: 'order'
                    }))
                }));
            }

            dealCartList(list) {
                const newList = [];
                
                for (const item of list) {
                    if (item.pcbGoods) {
                        newList.push({
                            title: item.pcbGoods.gerberFile,
                            _orderCode: `${item.pcbGoods.goodsCode}-${item.pcbGoods.customerCode}`,
                            orderCode: item.pcbGoods.goodsCode,
                            customerCode: item.pcbGoods.customerCode,
                            orderCount: item.pcbGoods.quantity,
                            imgUrl: this.getPCBImageUrl(item.pcbGoods),
                            orderAmount: `$${item.pcbGoods.price}`,
                            businessType: 'order_pcb',
                            source: 'cart'
                        });
                    }
                }
                
                return newList;
            }

            getOrderImageUrl(item) {
                if (item.businessType === 'order_steel') {
                    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iMjAiIHk9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOTk5Ij5TVEVFTDwvdGV4dD48L3N2Zz4=';
                }
                return `https://test-pcb.jlcpcb.com/api/overseas-pcb-order/v1/fileCommon/downloadCommonFile?fileAccessId=${item.fileAccessId}`;
            }

            getPCBImageUrl(pcbGoods) {
                return `https://test-shop-cart.jlcpcb.com/api/overseas-shop-cart/v1/file/downImg?small=1&uuid=${pcbGoods.technologyDiscernNum}&type=top&color=Green`;
            }

            getDateByBatchNum(batchNum) {
                const year = batchNum.slice(1, 5);
                const month = batchNum.slice(5, 7);
                const day = batchNum.slice(7, 9);
                return `${year}-${month}-${day}`;
            }
        }

        // 创建订单选择器实例
        const orderSelector = new OrderSelector();
        orderSelector.mount(document.getElementById('order-selector-container'));
        
        // 设置发送订单回调
        orderSelector.setOnSendOrderCallback((orderItem) => {
            const orderMessage = `📦 订单信息
订单号: ${orderItem._orderCode}
产品名称: ${orderItem.title}
数量: ${orderItem.orderCount}
金额: ${orderItem.orderAmount}
类型: ${orderItem.businessType}`;
            
            window.quickChatApi.sendMessage(orderMessage);
        });

        // 设置全局引用
        window.orderSelector = orderSelector;

        // 全局函数
        window.showOrderSelector = () => {
            orderSelector.show();
        };

        window.hideOrderSelector = () => {
            orderSelector.hide();
        };
    </script>
</body>
</html>