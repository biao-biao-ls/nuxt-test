<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>按钮修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .iframe-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
            height: 300px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 6px;
        }
        .footer-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 10px 0;
        }
        .footer-btn:hover {
            background: #0056b3;
        }
        .status {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        #simple-order-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>按钮修复测试</h1>
        <p>测试修复后的订单按钮点击功能。</p>
        
        <div class="status" id="status">等待初始化...</div>
        
        <h3>主窗口测试</h3>
        <button class="footer-btn" onclick="if(window.handleOrderButtonClick) window.handleOrderButtonClick(); else if(window.parent && window.parent.postMessage) window.parent.postMessage({type:'TOGGLE_ORDER_SELECTOR'},'*');">
            📦 <span>订单按钮（主窗口）</span>
        </button>
        
        <h3>iframe 测试</h3>
        <div class="iframe-container">
            <iframe id="test-iframe" srcdoc="
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 20px; 
                            background: #f8f9fa;
                        }
                        .footer-btn {
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            margin: 10px 0;
                        }
                        .footer-btn:hover {
                            background: #0056b3;
                        }
                    </style>
                </head>
                <body>
                    <h3>iframe 内容</h3>
                    <p>这是 iframe 内部的内容。</p>
                    
                    <button class='footer-btn' onclick='if(window.handleOrderButtonClick) window.handleOrderButtonClick(); else if(window.parent && window.parent.postMessage) window.parent.postMessage({type:\"TOGGLE_ORDER_SELECTOR\"},\"*\");'>
                        📦 <span>订单按钮（iframe）</span>
                    </button>
                    
                    <div id='message-log'></div>
                    
                    <script>
                        // 监听来自父窗口的消息
                        window.addEventListener('message', function(event) {
                            const log = document.getElementById('message-log');
                            log.innerHTML += '<p>📨 收到消息: ' + JSON.stringify(event.data) + '</p>';
                        });
                        
                        // 定期检查函数是否可用
                        setInterval(function() {
                            const log = document.getElementById('message-log');
                            if (window.handleOrderButtonClick) {
                                log.innerHTML = '<p>✅ handleOrderButtonClick 函数可用</p>';
                            } else {
                                log.innerHTML = '<p>❌ handleOrderButtonClick 函数不可用</p>';
                            }
                        }, 2000);
                    </script>
                </body>
                </html>
            "></iframe>
        </div>
        
        <div id="simple-order-container"></div>
    </div>

    <script>
        // 模拟 QuickChat API
        window.quickChatApi = {
            sendMessage: (message) => {
                console.log('发送消息:', message);
                document.getElementById('status').innerHTML = '✅ 消息已发送: ' + message.substring(0, 50) + '...';
            }
        };

        // 简化版订单选择器类
        class SimpleOrderSelector {
            constructor() {
                this.isVisible = false;
                this.container = null;
                this.onSendOrderCallback = null;
                
                // 绑定全局方法
                window.simpleOrderSelector = this;
            }

            setOnSendOrderCallback(callback) {
                this.onSendOrderCallback = callback;
            }

            mount(container) {
                this.container = container;
                document.getElementById('status').innerHTML = '✅ 订单选择器已挂载';
            }

            toggle() {
                if (this.isVisible) {
                    this.hide();
                } else {
                    this.show();
                }
            }

            show() {
                if (this.isVisible || !this.container) return;
                
                this.isVisible = true;
                this.render();
                document.getElementById('status').innerHTML = '✅ 订单选择器已显示';
            }

            hide() {
                if (!this.isVisible || !this.container) return;
                
                this.isVisible = false;
                this.container.innerHTML = '';
                document.getElementById('status').innerHTML = '✅ 订单选择器已隐藏';
            }

            render() {
                if (!this.container || !this.isVisible) return;

                this.container.innerHTML = `
                    <div style="
                        position: relative;
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                        max-height: 400px;
                        overflow: hidden;
                        animation: slideUp 0.2s ease-out;
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 12px 16px;
                            border-bottom: 1px solid #e0e0e0;
                            background: #f8f9fa;
                        ">
                            <span style="font-size: 14px; font-weight: 600; color: #333;">快速选择订单</span>
                            <span onclick="window.simpleOrderSelector && window.simpleOrderSelector.hide()" style="
                                cursor: pointer;
                                font-size: 18px;
                                color: #999;
                                width: 20px;
                                height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 50%;
                                transition: all 0.2s;
                            ">×</span>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <div onclick="window.simpleOrderSelector && window.simpleOrderSelector.selectOrder('Y11898-5011496A')" style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 12px 16px;
                                cursor: pointer;
                                transition: background-color 0.2s;
                                border-bottom: 1px solid #f0f0f0;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                                <div>
                                    <div style="font-size: 13px; font-weight: 500; color: #333; margin-bottom: 2px;">pcbwenjian2(Reorder)_Y11898</div>
                                    <div style="font-size: 11px; color: #666;">Y11898-5011496A</div>
                                </div>
                                <div style="font-size: 13px; font-weight: 600; color: #007bff; margin-left: 12px;">$15.63</div>
                            </div>
                            <div onclick="window.simpleOrderSelector && window.simpleOrderSelector.selectOrder('SMS2510133000010')" style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 12px 16px;
                                cursor: pointer;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                                <div>
                                    <div style="font-size: 13px; font-weight: 500; color: #333; margin-bottom: 2px;">1.STEP</div>
                                    <div style="font-size: 11px; color: #666;">SMS2510133000010</div>
                                </div>
                                <div style="font-size: 13px; font-weight: 600; color: #007bff; margin-left: 12px;">$8.22</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            selectOrder(orderCode) {
                const orders = {
                    'Y11898-5011496A': { title: 'pcbwenjian2(Reorder)_Y11898', orderCode: 'Y11898-5011496A', orderAmount: '$15.63', businessType: 'order_pcb' },
                    'SMS2510133000010': { title: '1.STEP', orderCode: 'SMS2510133000010', orderAmount: '$8.22', businessType: 'order_plate_metal' }
                };
                
                const selectedOrder = orders[orderCode];
                if (selectedOrder && this.onSendOrderCallback) {
                    this.onSendOrderCallback(selectedOrder);
                    this.hide();
                }
            }
        }

        // 模拟 ChatCustomUI 的 handleOrderButtonClick 方法
        function handleOrderButtonClick() {
            try {
                // 尝试在当前窗口中查找
                if (window.simpleOrderSelector) {
                    window.simpleOrderSelector.toggle();
                    return;
                }
                
                // 尝试在父窗口中查找
                if (window.parent && window.parent.simpleOrderSelector) {
                    window.parent.simpleOrderSelector.toggle();
                    return;
                }
                
                // 尝试在顶级窗口中查找
                if (window.top && window.top.simpleOrderSelector) {
                    window.top.simpleOrderSelector.toggle();
                    return;
                }
                
                // 使用 postMessage 通信
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'TOGGLE_ORDER_SELECTOR' }, '*');
                }
                
                console.warn('无法找到 simpleOrderSelector 实例');
            } catch (error) {
                console.error('处理订单按钮点击时出错:', error);
                // 降级处理：使用 postMessage
                try {
                    if (window.parent !== window) {
                        window.parent.postMessage({ type: 'TOGGLE_ORDER_SELECTOR' }, '*');
                    }
                } catch (e) {
                    console.error('postMessage 也失败了:', e);
                }
            }
        }

        // 创建简化版订单选择器实例
        const simpleOrderSelector = new SimpleOrderSelector();
        simpleOrderSelector.mount(document.getElementById('simple-order-container'));
        
        // 设置发送订单回调
        simpleOrderSelector.setOnSendOrderCallback((orderItem) => {
            const orderMessage = `📦 订单信息
订单号: ${orderItem.orderCode}
产品名称: ${orderItem.title}
金额: ${orderItem.orderAmount}
类型: ${orderItem.businessType}`;
            
            window.quickChatApi.sendMessage(orderMessage);
        });

        // 绑定全局函数
        window.handleOrderButtonClick = handleOrderButtonClick;

        // 监听来自 iframe 的消息
        window.addEventListener('message', (event) => {
            console.log('收到消息:', event.data);
            document.getElementById('status').innerHTML = '📨 收到消息: ' + JSON.stringify(event.data);
            
            if (event.data && event.data.type === 'TOGGLE_ORDER_SELECTOR') {
                simpleOrderSelector.toggle();
            }
        });

        // 尝试将函数绑定到 iframe
        setTimeout(() => {
            try {
                const iframe = document.getElementById('test-iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.handleOrderButtonClick = handleOrderButtonClick;
                    document.getElementById('status').innerHTML = '✅ 已绑定函数到 iframe';
                }
            } catch (error) {
                console.warn('无法绑定到 iframe:', error);
                document.getElementById('status').innerHTML = '⚠️ 无法绑定到 iframe，将使用 postMessage';
            }
        }, 1000);

        // 初始化状态
        document.getElementById('status').innerHTML = '✅ 系统已初始化，handleOrderButtonClick 函数已绑定';
    </script>
</body>
</html>