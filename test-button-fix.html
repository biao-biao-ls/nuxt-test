<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‰é’®ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .iframe-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
            height: 300px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 6px;
        }
        .footer-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 10px 0;
        }
        .footer-btn:hover {
            background: #0056b3;
        }
        .status {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        #simple-order-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>æŒ‰é’®ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„è®¢å•æŒ‰é’®ç‚¹å‡»åŠŸèƒ½ã€‚</p>
        
        <div class="status" id="status">ç­‰å¾…åˆå§‹åŒ–...</div>
        
        <h3>ä¸»çª—å£æµ‹è¯•</h3>
        <button class="footer-btn" onclick="if(window.handleOrderButtonClick) window.handleOrderButtonClick(); else if(window.parent && window.parent.postMessage) window.parent.postMessage({type:'TOGGLE_ORDER_SELECTOR'},'*');">
            ğŸ“¦ <span>è®¢å•æŒ‰é’®ï¼ˆä¸»çª—å£ï¼‰</span>
        </button>
        
        <h3>iframe æµ‹è¯•</h3>
        <div class="iframe-container">
            <iframe id="test-iframe" srcdoc="
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 20px; 
                            background: #f8f9fa;
                        }
                        .footer-btn {
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            margin: 10px 0;
                        }
                        .footer-btn:hover {
                            background: #0056b3;
                        }
                    </style>
                </head>
                <body>
                    <h3>iframe å†…å®¹</h3>
                    <p>è¿™æ˜¯ iframe å†…éƒ¨çš„å†…å®¹ã€‚</p>
                    
                    <button class='footer-btn' onclick='if(window.handleOrderButtonClick) window.handleOrderButtonClick(); else if(window.parent && window.parent.postMessage) window.parent.postMessage({type:\"TOGGLE_ORDER_SELECTOR\"},\"*\");'>
                        ğŸ“¦ <span>è®¢å•æŒ‰é’®ï¼ˆiframeï¼‰</span>
                    </button>
                    
                    <div id='message-log'></div>
                    
                    <script>
                        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
                        window.addEventListener('message', function(event) {
                            const log = document.getElementById('message-log');
                            log.innerHTML += '<p>ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(event.data) + '</p>';
                        });
                        
                        // å®šæœŸæ£€æŸ¥å‡½æ•°æ˜¯å¦å¯ç”¨
                        setInterval(function() {
                            const log = document.getElementById('message-log');
                            if (window.handleOrderButtonClick) {
                                log.innerHTML = '<p>âœ… handleOrderButtonClick å‡½æ•°å¯ç”¨</p>';
                            } else {
                                log.innerHTML = '<p>âŒ handleOrderButtonClick å‡½æ•°ä¸å¯ç”¨</p>';
                            }
                        }, 2000);
                    </script>
                </body>
                </html>
            "></iframe>
        </div>
        
        <div id="simple-order-container"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ QuickChat API
        window.quickChatApi = {
            sendMessage: (message) => {
                console.log('å‘é€æ¶ˆæ¯:', message);
                document.getElementById('status').innerHTML = 'âœ… æ¶ˆæ¯å·²å‘é€: ' + message.substring(0, 50) + '...';
            }
        };

        // ç®€åŒ–ç‰ˆè®¢å•é€‰æ‹©å™¨ç±»
        class SimpleOrderSelector {
            constructor() {
                this.isVisible = false;
                this.container = null;
                this.onSendOrderCallback = null;
                
                // ç»‘å®šå…¨å±€æ–¹æ³•
                window.simpleOrderSelector = this;
            }

            setOnSendOrderCallback(callback) {
                this.onSendOrderCallback = callback;
            }

            mount(container) {
                this.container = container;
                document.getElementById('status').innerHTML = 'âœ… è®¢å•é€‰æ‹©å™¨å·²æŒ‚è½½';
            }

            toggle() {
                if (this.isVisible) {
                    this.hide();
                } else {
                    this.show();
                }
            }

            show() {
                if (this.isVisible || !this.container) return;
                
                this.isVisible = true;
                this.render();
                document.getElementById('status').innerHTML = 'âœ… è®¢å•é€‰æ‹©å™¨å·²æ˜¾ç¤º';
            }

            hide() {
                if (!this.isVisible || !this.container) return;
                
                this.isVisible = false;
                this.container.innerHTML = '';
                document.getElementById('status').innerHTML = 'âœ… è®¢å•é€‰æ‹©å™¨å·²éšè—';
            }

            render() {
                if (!this.container || !this.isVisible) return;

                this.container.innerHTML = `
                    <div style="
                        position: relative;
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                        max-height: 400px;
                        overflow: hidden;
                        animation: slideUp 0.2s ease-out;
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 12px 16px;
                            border-bottom: 1px solid #e0e0e0;
                            background: #f8f9fa;
                        ">
                            <span style="font-size: 14px; font-weight: 600; color: #333;">å¿«é€Ÿé€‰æ‹©è®¢å•</span>
                            <span onclick="window.simpleOrderSelector && window.simpleOrderSelector.hide()" style="
                                cursor: pointer;
                                font-size: 18px;
                                color: #999;
                                width: 20px;
                                height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 50%;
                                transition: all 0.2s;
                            ">Ã—</span>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <div onclick="window.simpleOrderSelector && window.simpleOrderSelector.selectOrder('Y11898-5011496A')" style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 12px 16px;
                                cursor: pointer;
                                transition: background-color 0.2s;
                                border-bottom: 1px solid #f0f0f0;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                                <div>
                                    <div style="font-size: 13px; font-weight: 500; color: #333; margin-bottom: 2px;">pcbwenjian2(Reorder)_Y11898</div>
                                    <div style="font-size: 11px; color: #666;">Y11898-5011496A</div>
                                </div>
                                <div style="font-size: 13px; font-weight: 600; color: #007bff; margin-left: 12px;">$15.63</div>
                            </div>
                            <div onclick="window.simpleOrderSelector && window.simpleOrderSelector.selectOrder('SMS2510133000010')" style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 12px 16px;
                                cursor: pointer;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                                <div>
                                    <div style="font-size: 13px; font-weight: 500; color: #333; margin-bottom: 2px;">1.STEP</div>
                                    <div style="font-size: 11px; color: #666;">SMS2510133000010</div>
                                </div>
                                <div style="font-size: 13px; font-weight: 600; color: #007bff; margin-left: 12px;">$8.22</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            selectOrder(orderCode) {
                const orders = {
                    'Y11898-5011496A': { title: 'pcbwenjian2(Reorder)_Y11898', orderCode: 'Y11898-5011496A', orderAmount: '$15.63', businessType: 'order_pcb' },
                    'SMS2510133000010': { title: '1.STEP', orderCode: 'SMS2510133000010', orderAmount: '$8.22', businessType: 'order_plate_metal' }
                };
                
                const selectedOrder = orders[orderCode];
                if (selectedOrder && this.onSendOrderCallback) {
                    this.onSendOrderCallback(selectedOrder);
                    this.hide();
                }
            }
        }

        // æ¨¡æ‹Ÿ ChatCustomUI çš„ handleOrderButtonClick æ–¹æ³•
        function handleOrderButtonClick() {
            try {
                // å°è¯•åœ¨å½“å‰çª—å£ä¸­æŸ¥æ‰¾
                if (window.simpleOrderSelector) {
                    window.simpleOrderSelector.toggle();
                    return;
                }
                
                // å°è¯•åœ¨çˆ¶çª—å£ä¸­æŸ¥æ‰¾
                if (window.parent && window.parent.simpleOrderSelector) {
                    window.parent.simpleOrderSelector.toggle();
                    return;
                }
                
                // å°è¯•åœ¨é¡¶çº§çª—å£ä¸­æŸ¥æ‰¾
                if (window.top && window.top.simpleOrderSelector) {
                    window.top.simpleOrderSelector.toggle();
                    return;
                }
                
                // ä½¿ç”¨ postMessage é€šä¿¡
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'TOGGLE_ORDER_SELECTOR' }, '*');
                }
                
                console.warn('æ— æ³•æ‰¾åˆ° simpleOrderSelector å®ä¾‹');
            } catch (error) {
                console.error('å¤„ç†è®¢å•æŒ‰é’®ç‚¹å‡»æ—¶å‡ºé”™:', error);
                // é™çº§å¤„ç†ï¼šä½¿ç”¨ postMessage
                try {
                    if (window.parent !== window) {
                        window.parent.postMessage({ type: 'TOGGLE_ORDER_SELECTOR' }, '*');
                    }
                } catch (e) {
                    console.error('postMessage ä¹Ÿå¤±è´¥äº†:', e);
                }
            }
        }

        // åˆ›å»ºç®€åŒ–ç‰ˆè®¢å•é€‰æ‹©å™¨å®ä¾‹
        const simpleOrderSelector = new SimpleOrderSelector();
        simpleOrderSelector.mount(document.getElementById('simple-order-container'));
        
        // è®¾ç½®å‘é€è®¢å•å›è°ƒ
        simpleOrderSelector.setOnSendOrderCallback((orderItem) => {
            const orderMessage = `ğŸ“¦ è®¢å•ä¿¡æ¯
è®¢å•å·: ${orderItem.orderCode}
äº§å“åç§°: ${orderItem.title}
é‡‘é¢: ${orderItem.orderAmount}
ç±»å‹: ${orderItem.businessType}`;
            
            window.quickChatApi.sendMessage(orderMessage);
        });

        // ç»‘å®šå…¨å±€å‡½æ•°
        window.handleOrderButtonClick = handleOrderButtonClick;

        // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
            document.getElementById('status').innerHTML = 'ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(event.data);
            
            if (event.data && event.data.type === 'TOGGLE_ORDER_SELECTOR') {
                simpleOrderSelector.toggle();
            }
        });

        // å°è¯•å°†å‡½æ•°ç»‘å®šåˆ° iframe
        setTimeout(() => {
            try {
                const iframe = document.getElementById('test-iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.handleOrderButtonClick = handleOrderButtonClick;
                    document.getElementById('status').innerHTML = 'âœ… å·²ç»‘å®šå‡½æ•°åˆ° iframe';
                }
            } catch (error) {
                console.warn('æ— æ³•ç»‘å®šåˆ° iframe:', error);
                document.getElementById('status').innerHTML = 'âš ï¸ æ— æ³•ç»‘å®šåˆ° iframeï¼Œå°†ä½¿ç”¨ postMessage';
            }
        }, 1000);

        // åˆå§‹åŒ–çŠ¶æ€
        document.getElementById('status').innerHTML = 'âœ… ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼ŒhandleOrderButtonClick å‡½æ•°å·²ç»‘å®š';
    </script>
</body>
</html>