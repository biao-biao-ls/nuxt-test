<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客服离线功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .demo-header {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #fafafa;
            min-height: 50px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.danger {
            background: #dc3545;
        }
        .agent-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .agent-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: white;
        }
        .agent-card.current {
            border-color: #28a745;
            background: #d4edda;
        }
        .agent-card.offline {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online {
            background: #28a745;
        }
        .status-offline {
            background: #dc3545;
        }
        
        /* 复制的实际样式 */
        .current-agent {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-right: 12px;
        }

        .agent-avatar-wrapper {
          position: relative;
          flex-shrink: 0;
        }

        .default-avatar {
          display: block;
          border-radius: 50%;
          overflow: hidden;
        }

        .agent-avatar {
          border-radius: 50%;
          border: 1px solid #dee2e6;
          object-fit: fill;
        }

        .agent-avatar.current {
          width: 36px;
          height: 36px;
          border-width: 2px;
        }

        .agent-name-display {
          font-size: 14px;
          font-weight: 500;
          color: #444;
          white-space: nowrap;
        }

        .status-indicator-small {
          position: absolute;
          right: 0px;
          top: 2px;
          width: 6px;
          height: 6px;
          border: 1px solid white;
          border-radius: 50%;
          background: #48DE8C;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>客服离线功能测试</h1>
        
        <div class="section">
            <div class="title">当前客服显示区域</div>
            <div class="demo-header" id="current-agent-display">
                <!-- 当前客服信息将显示在这里 -->
            </div>
        </div>

        <div class="section">
            <div class="title">客服列表与状态控制</div>
            <div id="agent-list" class="agent-list">
                <!-- 客服列表将显示在这里 -->
            </div>
        </div>

        <div class="section">
            <div class="title">测试场景</div>
            <div style="margin-bottom: 10px;">
                <strong>场景1：选择客服后，模拟该客服离线</strong><br>
                <button onclick="testScenario1()" class="warning">测试场景1</button>
                <span style="font-size: 12px; color: #666;">（会自动选择一个客服，然后模拟其离线）</span>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong>场景2：手动控制客服状态</strong><br>
                <button onclick="setAllOnline()" class="success">所有客服上线</button>
                <button onclick="setAllOffline()" class="danger">所有客服离线</button>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong>场景3：状态检查</strong><br>
                <button onclick="checkCurrentStatus()">检查当前客服状态</button>
                <button onclick="refreshDisplay()">刷新显示</button>
                <button onclick="clearCurrentAgent()" class="warning">清除当前客服</button>
            </div>
        </div>

        <div class="section">
            <div class="title">测试日志</div>
            <div id="log-area" class="log-area"></div>
            <button onclick="clearLog()">清除日志</button>
        </div>
    </div>

    <script>
        // 模拟ChatCustomUI类
        class MockChatUI {
            constructor() {
                this.state = {
                    currentChatAgent: null,
                    customerServiceData: [
                        {
                            employeeEnName: "test_01",
                            quickCepId: "1938524999731687426",
                            imageFileIndexId: "8454635530497527808",
                            roleNameEn: "Business Development Representative",
                            isOnline: true,
                            status: 2,
                            businessLine: "3D Printing",
                        },
                        {
                            employeeEnName: "caocao",
                            quickCepId: "1942407035945005058",
                            imageFileIndexId: "8454682774852571136",
                            roleNameEn: "Quality Assurance Agent",
                            isOnline: true,
                            status: 2,
                            businessLine: "3D Printing",
                        },
                        {
                            employeeEnName: "xiaozhou",
                            quickCepId: "1938144757068906498",
                            imageFileIndexId: "8593772030083227648",
                            roleNameEn: "Technical Support Specialist",
                            isOnline: false,
                            status: 1,
                            businessLine: "PCB Assembly",
                        }
                    ]
                };
            }

            selectAgent(quickCepId) {
                const agent = this.state.customerServiceData.find(a => a.quickCepId === quickCepId);
                if (agent && agent.isOnline) {
                    this.state.currentChatAgent = agent;
                    this.refreshUI();
                    log(`切换到客服: ${agent.employeeEnName}`);
                } else if (agent) {
                    log(`客服 ${agent.employeeEnName} 当前离线，无法切换`);
                }
            }

            checkCurrentAgentStatus() {
                if (!this.state.currentChatAgent) {
                    return false;
                }

                const currentAgent = this.state.customerServiceData.find(
                    agent => agent.quickCepId === this.state.currentChatAgent.quickCepId
                );

                if (!currentAgent || !currentAgent.isOnline) {
                    log(`当前客服 ${this.state.currentChatAgent.employeeEnName} 已离线，自动恢复为默认客服`);
                    this.state.currentChatAgent = null;
                    this.refreshUI();
                    return true;
                }

                return false;
            }

            refreshUI() {
                // 在刷新UI之前，检查当前客服是否仍在线
                this.checkCurrentAgentStatus();
                
                updateCurrentAgentDisplay();
                updateAgentList();
            }

            renderCurrentAgent() {
                if (!this.state.currentChatAgent) {
                    return `
                        <div class="current-agent" title="当前客服: JLCONE">
                            <div class="agent-avatar-wrapper">
                                <svg width="36" height="36" viewBox="0 0 1024 1024" style="border-radius: 50%;">
                                    <path d="M512 512m-512 0a512 512 0 1 0 1024 0 512 512 0 1 0-1024 0Z" fill="#2B8CED"></path>
                                    <path d="M699.120941 570.819765l167.032471 0.180706c-4.216471 11.836235..." fill="#FFFFFF"></path>
                                </svg>
                            </div>
                            <div class="agent-name-display">JLCONE</div>
                        </div>
                    `;
                }

                const agent = this.state.currentChatAgent;
                return `
                    <div class="current-agent" title="当前沟通: ${agent.employeeEnName}">
                        <div class="agent-avatar-wrapper">
                            <img src="https://test.jlcerp.com/api/overseas-manage/employee/image/preview/${agent.imageFileIndexId}" 
                                 class="agent-avatar current"
                                 style="border-color: ${agent.isOnline ? '#28a745' : '#dc3545'};"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSI+PGNpcmNsZSBjeD0iMTgiIGN5PSIxOCIgcj0iMTgiIGZpbGw9IiNlOWVjZWYiLz48L3N2Zz4='">
                            <div class="status-indicator-small" style="background: ${agent.isOnline ? '#28a745' : '#dc3545'};"></div>
                        </div>
                        <div class="agent-name-display">${agent.employeeEnName}</div>
                    </div>
                `;
            }
        }

        // 创建实例
        const mockChatUI = new MockChatUI();
        window.chatUI = mockChatUI;

        // 日志功能
        function log(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = '';
        }

        // 更新显示
        function updateCurrentAgentDisplay() {
            const container = document.getElementById('current-agent-display');
            container.innerHTML = mockChatUI.renderCurrentAgent();
        }

        function updateAgentList() {
            const container = document.getElementById('agent-list');
            container.innerHTML = mockChatUI.state.customerServiceData.map(agent => {
                const isCurrent = mockChatUI.state.currentChatAgent && 
                                mockChatUI.state.currentChatAgent.quickCepId === agent.quickCepId;
                return `
                    <div class="agent-card ${isCurrent ? 'current' : ''} ${!agent.isOnline ? 'offline' : ''}">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            <span class="status-indicator ${agent.isOnline ? 'status-online' : 'status-offline'}"></span>
                            <strong>${agent.employeeEnName}</strong>
                            ${isCurrent ? '<span style="color: #28a745; margin-left: 10px;">● 当前</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${agent.roleNameEn}</div>
                        <div style="font-size: 12px; color: ${agent.isOnline ? '#28a745' : '#dc3545'};">
                            ${agent.isOnline ? '在线' : '离线'}
                        </div>
                        <div style="margin-top: 8px;">
                            <button onclick="selectAgent('${agent.quickCepId}')" ${!agent.isOnline ? 'disabled' : ''}>选择</button>
                            <button onclick="toggleAgentStatus('${agent.quickCepId}')" class="${agent.isOnline ? 'danger' : 'success'}">
                                ${agent.isOnline ? '设为离线' : '设为在线'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 测试函数
        function selectAgent(quickCepId) {
            log(`点击选择客服: ${quickCepId}`);
            mockChatUI.selectAgent(quickCepId);
        }

        function toggleAgentStatus(quickCepId) {
            const agent = mockChatUI.state.customerServiceData.find(a => a.quickCepId === quickCepId);
            if (agent) {
                agent.isOnline = !agent.isOnline;
                agent.status = agent.isOnline ? 2 : 1;
                log(`${agent.employeeEnName} 状态切换为: ${agent.isOnline ? '在线' : '离线'}`);
                mockChatUI.refreshUI();
            }
        }

        function testScenario1() {
            log('=== 开始测试场景1 ===');
            
            // 先确保有在线客服
            const onlineAgent = mockChatUI.state.customerServiceData.find(a => a.isOnline);
            if (!onlineAgent) {
                log('没有在线客服，先设置一个客服为在线状态');
                mockChatUI.state.customerServiceData[0].isOnline = true;
                mockChatUI.state.customerServiceData[0].status = 2;
            }
            
            // 选择第一个在线客服
            const targetAgent = mockChatUI.state.customerServiceData.find(a => a.isOnline);
            log(`1. 选择客服: ${targetAgent.employeeEnName}`);
            mockChatUI.selectAgent(targetAgent.quickCepId);
            
            // 等待2秒后模拟该客服离线
            setTimeout(() => {
                log(`2. 模拟客服 ${targetAgent.employeeEnName} 离线`);
                targetAgent.isOnline = false;
                targetAgent.status = 1;
                
                log('3. 刷新UI，检查是否自动恢复为默认状态');
                mockChatUI.refreshUI();
                
                if (!mockChatUI.state.currentChatAgent) {
                    log('✅ 测试成功：当前客服已自动清除，恢复为默认状态');
                } else {
                    log('❌ 测试失败：当前客服未被清除');
                }
                log('=== 场景1测试完成 ===');
            }, 2000);
        }

        function setAllOnline() {
            log('设置所有客服为在线状态');
            mockChatUI.state.customerServiceData.forEach(agent => {
                agent.isOnline = true;
                agent.status = 2;
            });
            mockChatUI.refreshUI();
        }

        function setAllOffline() {
            log('设置所有客服为离线状态');
            mockChatUI.state.customerServiceData.forEach(agent => {
                agent.isOnline = false;
                agent.status = 1;
            });
            mockChatUI.refreshUI();
        }

        function checkCurrentStatus() {
            const result = mockChatUI.checkCurrentAgentStatus();
            if (result) {
                log('当前客服已离线，已自动恢复为默认状态');
            } else {
                log('当前客服状态正常或无当前客服');
            }
        }

        function refreshDisplay() {
            log('手动刷新显示');
            mockChatUI.refreshUI();
        }

        function clearCurrentAgent() {
            log('手动清除当前客服');
            mockChatUI.state.currentChatAgent = null;
            mockChatUI.refreshUI();
        }

        // 初始化
        log('客服离线功能测试页面已加载');
        log('提示：选择一个客服后，点击"设为离线"按钮，观察当前客服区域是否自动恢复为默认状态');
        updateCurrentAgentDisplay();
        updateAgentList();
    </script>
</body>
</html>