<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æœçŠ¶æ€ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .log-area {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®¢æœçŠ¶æ€ä¿®å¤æµ‹è¯•</h1>
        
        <div class="info">
            <strong>ä¿®å¤è¯´æ˜ï¼š</strong>
            <p>ä¿®å¤äº† useChatManager.ts ä¸­å®¢æœåœ¨çº¿çŠ¶æ€åˆ¤æ–­çš„é—®é¢˜ï¼š</p>
            <ul>
                <li>ç§»é™¤äº†åœ¨ handleOperatorListChange æ–¹æ³•ä¸­ç›´æ¥ä½¿ç”¨ currentOperator.onlineStatus æ›´æ–°çŠ¶æ€çš„é€»è¾‘</li>
                <li>æ”¹ä¸ºä¾èµ– 'chat.operator.status' äº‹ä»¶çš„ data.operatorUserIdStatus æ¥æ›´æ–°å®¢æœçŠ¶æ€</li>
                <li>åœ¨åº§å¸­åˆ—è¡¨å˜åŒ–åï¼Œä¸»åŠ¨è§¦å‘è·å–æœ€æ–°çš„å®¢æœçŠ¶æ€</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>1. æ¨¡æ‹Ÿå®¢æœçŠ¶æ€äº‹ä»¶</h3>
            <p>æµ‹è¯• chat.operator.status äº‹ä»¶æ˜¯å¦æ­£ç¡®å¤„ç† operatorUserIdStatus</p>
            <button onclick="simulateOperatorStatusEvent()">æ¨¡æ‹Ÿå®¢æœçŠ¶æ€æ›´æ–°äº‹ä»¶</button>
            <button onclick="simulateOperatorListChange()">æ¨¡æ‹Ÿåº§å¸­åˆ—è¡¨å˜åŒ–äº‹ä»¶</button>
            <div class="status-display" id="statusDisplay">ç­‰å¾…äº‹ä»¶è§¦å‘...</div>
        </div>

        <div class="test-section">
            <h3>2. å®¢æœçŠ¶æ€æ£€æŸ¥</h3>
            <p>æ£€æŸ¥å½“å‰å®¢æœçŠ¶æ€å’Œåœ¨çº¿çŠ¶æ€</p>
            <button onclick="checkAgentStatus()">æ£€æŸ¥å®¢æœçŠ¶æ€</button>
            <button onclick="getCurrentAgent()">è·å–å½“å‰å®¢æœ</button>
            <button onclick="fetchAgentStatus()">æ‰‹åŠ¨è·å–å®¢æœçŠ¶æ€</button>
            <div class="status-display" id="agentStatusDisplay">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹çŠ¶æ€...</div>
        </div>

        <div class="test-section">
            <h3>3. äº‹ä»¶æµç¨‹æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„äº‹ä»¶å¤„ç†æµç¨‹</p>
            <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div class="log-area" id="logArea"></div>
        </div>

        <div class="warning">
            <strong>æ³¨æ„ï¼š</strong>
            <p>æ­¤æµ‹è¯•éœ€è¦åœ¨é›†æˆäº† QuickChat SDK çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œç¡®ä¿ window.quickEmitter å’Œ window.quickChatApi å¯ç”¨ã€‚</p>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('logArea');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function simulateOperatorStatusEvent() {
            if (typeof window.quickEmitter === 'undefined') {
                log('âŒ QuickChat SDK æœªåŠ è½½ï¼Œæ— æ³•æ¨¡æ‹Ÿäº‹ä»¶');
                return;
            }

            // æ¨¡æ‹Ÿå®¢æœçŠ¶æ€æ•°æ®
            const mockStatusData = {
                operatorUserIdStatus: {
                    'agent001': 2, // åœ¨çº¿ç©ºé—²
                    'agent002': 3, // åœ¨çº¿å¿™ç¢Œ
                    'agent003': 1  // ç¦»çº¿
                }
            };

            log('ğŸ”„ æ¨¡æ‹Ÿè§¦å‘ chat.operator.status äº‹ä»¶');
            log(`ğŸ“Š çŠ¶æ€æ•°æ®: ${JSON.stringify(mockStatusData.operatorUserIdStatus)}`);
            
            window.quickEmitter.emit('chat.operator.status', mockStatusData);
            
            document.getElementById('statusDisplay').innerHTML = 
                `å·²è§¦å‘ chat.operator.status äº‹ä»¶<br>` +
                `çŠ¶æ€æ•°æ®: ${JSON.stringify(mockStatusData.operatorUserIdStatus, null, 2)}`;
        }

        function simulateOperatorListChange() {
            if (typeof window.quickEmitter === 'undefined') {
                log('âŒ QuickChat SDK æœªåŠ è½½ï¼Œæ— æ³•æ¨¡æ‹Ÿäº‹ä»¶');
                return;
            }

            // æ¨¡æ‹Ÿåº§å¸­åˆ—è¡¨å˜åŒ–æ•°æ®
            const mockListChangeData = [
                {
                    operatorId: 'agent001',
                    onlineStatus: 2, // æ³¨æ„ï¼šè¿™ä¸ªå­—æ®µä¸åº”è¯¥è¢«ç”¨æ¥æ›´æ–°å®¢æœçŠ¶æ€
                    name: 'å®¢æœå°ç‹'
                }
            ];

            log('ğŸ”„ æ¨¡æ‹Ÿè§¦å‘ chat.operatorList.change äº‹ä»¶');
            log(`ğŸ“‹ åº§å¸­æ•°æ®: ${JSON.stringify(mockListChangeData)}`);
            
            window.quickEmitter.emit('chat.operatorList.change', mockListChangeData);
            
            document.getElementById('statusDisplay').innerHTML = 
                `å·²è§¦å‘ chat.operatorList.change äº‹ä»¶<br>` +
                `åº§å¸­æ•°æ®: ${JSON.stringify(mockListChangeData, null, 2)}`;
        }

        function checkAgentStatus() {
            if (typeof window.debugQuickChat === 'undefined') {
                log('âŒ è°ƒè¯•å·¥å…·æœªåŠ è½½');
                document.getElementById('agentStatusDisplay').innerHTML = 'è°ƒè¯•å·¥å…·æœªåŠ è½½';
                return;
            }

            log('ğŸ” æ£€æŸ¥å®¢æœçŠ¶æ€');
            const agentData = window.debugQuickChat.getAgentData();
            
            if (agentData && agentData.length > 0) {
                let statusHtml = '<strong>å®¢æœçŠ¶æ€åˆ—è¡¨ï¼š</strong><br>';
                agentData.forEach(agent => {
                    const statusText = getStatusText(agent.status);
                    const onlineText = agent.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    statusHtml += `${agent.employeeEnName}: ${statusText} (${onlineText})<br>`;
                    log(`ğŸ‘¤ ${agent.employeeEnName}: ${statusText} (${onlineText})`);
                });
                
                document.getElementById('agentStatusDisplay').innerHTML = statusHtml;
            } else {
                log('âŒ æœªæ‰¾åˆ°å®¢æœæ•°æ®');
                document.getElementById('agentStatusDisplay').innerHTML = 'æœªæ‰¾åˆ°å®¢æœæ•°æ®';
            }
        }

        function getCurrentAgent() {
            if (typeof window.debugQuickChat === 'undefined') {
                log('âŒ è°ƒè¯•å·¥å…·æœªåŠ è½½');
                return;
            }

            log('ğŸ¯ è·å–å½“å‰å®¢æœ');
            const currentAgent = window.debugQuickChat.getCurrentAgent();
            
            if (currentAgent) {
                const statusText = getStatusText(currentAgent.status);
                const onlineText = currentAgent.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const info = `å½“å‰å®¢æœ: ${currentAgent.employeeEnName} (${statusText}, ${onlineText})`;
                
                log(`âœ… ${info}`);
                document.getElementById('agentStatusDisplay').innerHTML = info;
            } else {
                log('â„¹ï¸ å½“å‰æ²¡æœ‰é€‰ä¸­çš„å®¢æœ');
                document.getElementById('agentStatusDisplay').innerHTML = 'å½“å‰æ²¡æœ‰é€‰ä¸­çš„å®¢æœ';
            }
        }

        function fetchAgentStatus() {
            if (typeof window.quickChatApi === 'undefined') {
                log('âŒ QuickChat API æœªåŠ è½½');
                return;
            }

            log('ğŸ”„ æ‰‹åŠ¨è§¦å‘è·å–å®¢æœçŠ¶æ€');
            
            // æ¨¡æ‹Ÿè·å–æ‰€æœ‰å®¢æœID
            const allQuickCepIds = ['agent001', 'agent002', 'agent003'];
            window.quickChatApi.emitGetAllOperatorStatus(allQuickCepIds);
            
            log(`ğŸ“¡ å·²å‘é€çŠ¶æ€æŸ¥è¯¢è¯·æ±‚: ${JSON.stringify(allQuickCepIds)}`);
        }

        function testCompleteFlow() {
            log('ğŸš€ å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•');
            log('='.repeat(50));
            
            // æ­¥éª¤1: æ¨¡æ‹Ÿåº§å¸­åˆ—è¡¨å˜åŒ–
            setTimeout(() => {
                log('ğŸ“‹ æ­¥éª¤1: æ¨¡æ‹Ÿåº§å¸­åˆ—è¡¨å˜åŒ–');
                simulateOperatorListChange();
            }, 500);
            
            // æ­¥éª¤2: æ¨¡æ‹Ÿå®¢æœçŠ¶æ€æ›´æ–°
            setTimeout(() => {
                log('ğŸ“Š æ­¥éª¤2: æ¨¡æ‹Ÿå®¢æœçŠ¶æ€æ›´æ–°');
                simulateOperatorStatusEvent();
            }, 1500);
            
            // æ­¥éª¤3: æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
            setTimeout(() => {
                log('ğŸ” æ­¥éª¤3: æ£€æŸ¥æœ€ç»ˆçŠ¶æ€');
                checkAgentStatus();
                getCurrentAgent();
                log('âœ… å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ');
                log('='.repeat(50));
            }, 3000);
        }

        function clearLogs() {
            logArea.innerHTML = '';
        }

        function getStatusText(status) {
            switch(status) {
                case 1: return 'ç¦»çº¿';
                case 2: return 'åœ¨çº¿ç©ºé—²';
                case 3: return 'åœ¨çº¿å¿™ç¢Œ';
                default: return 'æœªçŸ¥çŠ¶æ€';
            }
        }

        // ç›‘å¬ç›¸å…³äº‹ä»¶
        window.addEventListener('load', () => {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥ QuickChat SDK çŠ¶æ€
            setTimeout(() => {
                if (typeof window.quickEmitter !== 'undefined' && typeof window.quickChatApi !== 'undefined') {
                    log('âœ… QuickChat SDK å·²åŠ è½½');
                    
                    // ç›‘å¬ç›¸å…³äº‹ä»¶
                    window.quickEmitter.on('chat.operator.status', (data) => {
                        log('ğŸ“¡ æ¥æ”¶åˆ° chat.operator.status äº‹ä»¶');
                        log(`ğŸ“Š æ•°æ®: ${JSON.stringify(data)}`);
                    });
                    
                    window.quickEmitter.on('chat.operatorList.change', (data) => {
                        log('ğŸ“¡ æ¥æ”¶åˆ° chat.operatorList.change äº‹ä»¶');
                        log(`ğŸ“‹ æ•°æ®: ${JSON.stringify(data)}`);
                    });
                    
                } else {
                    log('âš ï¸ QuickChat SDK æœªåŠ è½½ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨');
                }
                
                if (typeof window.debugQuickChat !== 'undefined') {
                    log('âœ… è°ƒè¯•å·¥å…·å·²åŠ è½½');
                } else {
                    log('âš ï¸ è°ƒè¯•å·¥å…·æœªåŠ è½½ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨');
                }
            }, 1000);
        });
    </script>
</body>
</html>