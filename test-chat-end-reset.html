<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试会话关闭恢复默认客服</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #005a87;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #e7f3ff;
            border-left: 4px solid #007cba;
        }
        .log {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>测试会话关闭恢复默认客服功能</h1>
    
    <div class="test-section">
        <h3>功能说明</h3>
        <p>此测试页面用于验证当聊天会话关闭时，系统是否能正确恢复客服信息为默认状态。</p>
        <p>主要测试点：</p>
        <ul>
            <li>监听 <code>chat.end</code> 事件</li>
            <li>清除当前选择的客服信息</li>
            <li>清除本地存储的客服选择</li>
            <li>刷新UI显示为默认状态</li>
            <li>更新左侧栏可见性</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>当前状态</h3>
        <div id="currentStatus" class="status">
            正在初始化...
        </div>
    </div>

    <div class="test-section">
        <h3>测试操作</h3>
        <button class="button" onclick="selectTestAgent()">选择测试客服</button>
        <button class="button" onclick="simulateChatEnd()">模拟会话关闭</button>
        <button class="button" onclick="checkCurrentAgent()">检查当前客服</button>
        <button class="button" onclick="checkLocalStorage()">检查本地存储</button>
        <button class="button" onclick="clearLog()">清除日志</button>
    </div>

    <div class="test-section">
        <h3>测试日志</h3>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        let chatManager = null;
        let mockQuickEmitter = null;

        // 模拟 QuickChat API 和事件系统
        function setupMockAPI() {
            // 创建模拟的事件发射器
            mockQuickEmitter = {
                listeners: {},
                on: function(event, callback) {
                    if (!this.listeners[event]) {
                        this.listeners[event] = [];
                    }
                    this.listeners[event].push(callback);
                    log(`注册事件监听器: ${event}`);
                },
                emit: function(event, data) {
                    log(`触发事件: ${event}`, data);
                    if (this.listeners[event]) {
                        this.listeners[event].forEach(callback => {
                            try {
                                callback(data);
                            } catch (error) {
                                log(`事件处理器错误: ${error.message}`, 'error');
                            }
                        });
                    }
                },
                off: function(event) {
                    delete this.listeners[event];
                    log(`移除事件监听器: ${event}`);
                }
            };

            // 设置全局对象
            window.quickEmitter = mockQuickEmitter;
            window.quickChatApi = {
                switchChat: function(userId) {
                    log(`模拟切换客服: ${userId}`);
                    return Promise.resolve();
                },
                emitGetAllOperatorStatus: function(operators) {
                    log(`模拟获取客服状态: ${operators.join(', ')}`);
                },
                customHeader: {
                    mount: function(callback) {
                        const mockContainer = document.createElement('div');
                        mockContainer.id = 'mock-header';
                        callback(mockContainer);
                        log('挂载头部组件');
                    }
                },
                customLeftBar: {
                    mount: function(callback) {
                        const mockContainer = document.createElement('div');
                        mockContainer.id = 'mock-leftbar';
                        callback(mockContainer);
                        log('挂载左侧栏组件');
                    },
                    setIsShow: function(show) {
                        log(`设置左侧栏显示状态: ${show}`);
                    }
                },
                customFooter: {
                    mount: function(callback) {
                        const mockContainer = document.createElement('div');
                        mockContainer.id = 'mock-footer';
                        callback(mockContainer);
                        log('挂载底部组件');
                    }
                }
            };

            log('模拟 QuickChat API 初始化完成');
        }

        // 初始化测试环境
        async function initTest() {
            try {
                setupMockAPI();

                // 模拟客服数据
                const mockCustomerServiceData = [
                    {
                        quickCepId: 'test-agent-1',
                        employeeEnName: 'Test Agent 1',
                        employeeCnName: '测试客服1',
                        avatar: '',
                        businessType: 'order_pcb',
                        isOnline: true,
                        status: 2
                    },
                    {
                        quickCepId: 'test-agent-2',
                        employeeEnName: 'Test Agent 2',
                        employeeCnName: '测试客服2',
                        avatar: '',
                        businessType: 'order_smt',
                        isOnline: true,
                        status: 2
                    }
                ];

                // 动态导入 ChatManager（在实际环境中）
                // 这里我们模拟一个简化版本
                chatManager = {
                    chatUI: {
                        state: {
                            currentChatAgent: null,
                            customerServiceData: mockCustomerServiceData
                        },
                        resetToDefaultAgent: function() {
                            log('调用 resetToDefaultAgent 方法');
                            this.state.currentChatAgent = null;
                            // 模拟清除本地存储
                            try {
                                localStorage.removeItem('quickchat_selected_agent');
                                log('已清除本地存储的客服选择');
                            } catch (error) {
                                log(`清除本地存储失败: ${error.message}`, 'error');
                            }
                            log('UI已刷新为默认状态');
                        },
                        selectAgent: function(quickCepId) {
                            const agent = this.state.customerServiceData.find(a => a.quickCepId === quickCepId);
                            if (agent) {
                                this.state.currentChatAgent = agent;
                                // 模拟保存到本地存储
                                try {
                                    localStorage.setItem('quickchat_selected_agent', JSON.stringify(agent));
                                    log(`已选择客服: ${agent.employeeEnName}`);
                                } catch (error) {
                                    log(`保存到本地存储失败: ${error.message}`, 'error');
                                }
                            }
                        }
                    },
                    resetToDefaultAgent: function() {
                        log('ChatManager.resetToDefaultAgent 被调用');
                        if (this.chatUI) {
                            this.chatUI.resetToDefaultAgent();
                        }
                    }
                };

                // 模拟事件监听器注册
                window.quickEmitter.on('chat.end', (data) => {
                    log('监听到会话关闭事件', data);
                    chatManager.resetToDefaultAgent();
                });

                updateStatus();
                log('测试环境初始化完成');

            } catch (error) {
                log(`初始化失败: ${error.message}`, 'error');
            }
        }

        // 选择测试客服
        function selectTestAgent() {
            if (chatManager && chatManager.chatUI) {
                chatManager.chatUI.selectAgent('test-agent-1');
                updateStatus();
                log('已选择测试客服1');
            } else {
                log('ChatManager 未初始化', 'error');
            }
        }

        // 模拟会话关闭
        function simulateChatEnd() {
            if (window.quickEmitter) {
                const eventData = {
                    sessionId: 'test-session-123',
                    timestamp: new Date().toISOString(),
                    reason: 'user_ended'
                };
                window.quickEmitter.emit('chat.end', eventData);
                updateStatus();
                log('已模拟会话关闭事件');
            } else {
                log('QuickEmitter 未初始化', 'error');
            }
        }

        // 检查当前客服
        function checkCurrentAgent() {
            if (chatManager && chatManager.chatUI) {
                const currentAgent = chatManager.chatUI.state.currentChatAgent;
                if (currentAgent) {
                    log(`当前客服: ${currentAgent.employeeEnName} (${currentAgent.quickCepId})`);
                } else {
                    log('当前没有选择客服（默认状态）');
                }
            } else {
                log('ChatManager 未初始化', 'error');
            }
        }

        // 检查本地存储
        function checkLocalStorage() {
            try {
                const storedAgent = localStorage.getItem('quickchat_selected_agent');
                if (storedAgent) {
                    const agentData = JSON.parse(storedAgent);
                    log(`本地存储的客服: ${agentData.employeeEnName} (${agentData.quickCepId})`);
                } else {
                    log('本地存储中没有客服选择（默认状态）');
                }
            } catch (error) {
                log(`检查本地存储失败: ${error.message}`, 'error');
            }
        }

        // 更新状态显示
        function updateStatus() {
            const statusDiv = document.getElementById('currentStatus');
            let statusText = '';

            if (chatManager && chatManager.chatUI) {
                const currentAgent = chatManager.chatUI.state.currentChatAgent;
                if (currentAgent) {
                    statusText = `当前客服: ${currentAgent.employeeEnName} (${currentAgent.quickCepId})`;
                } else {
                    statusText = '当前状态: 默认状态（未选择客服）';
                }

                // 检查本地存储
                try {
                    const storedAgent = localStorage.getItem('quickchat_selected_agent');
                    if (storedAgent) {
                        const agentData = JSON.parse(storedAgent);
                        statusText += `<br>本地存储: ${agentData.employeeEnName}`;
                    } else {
                        statusText += '<br>本地存储: 无';
                    }
                } catch (error) {
                    statusText += '<br>本地存储: 读取失败';
                }
            } else {
                statusText = '系统未初始化';
            }

            statusDiv.innerHTML = statusText;
        }

        // 日志记录
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
            
            let logText = `[${timestamp}] ${message}`;
            if (typeof arguments[1] === 'object' && arguments[1] !== null) {
                logText += ' ' + JSON.stringify(arguments[1]);
            }
            
            logEntry.textContent = logText;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 清除日志
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // 页面加载时初始化
        window.addEventListener('load', initTest);
    </script>
</body>
</html>