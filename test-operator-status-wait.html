<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•åº§å¸­çŠ¶æ€ç­‰å¾…æœºåˆ¶</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-weight: bold;
        }
        .status.waiting {
            background: #fff3cd;
            color: #856404;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.processing {
            background: #cce7ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æµ‹è¯•åº§å¸­çŠ¶æ€ç­‰å¾…æœºåˆ¶</h1>
        <p>è¿™ä¸ªæµ‹è¯•é¡µé¢ç”¨äºéªŒè¯ <code>chat.operatorList.change</code> äº‹ä»¶æ˜¯å¦æ­£ç¡®ç­‰å¾… <code>chat.operator.status</code> äº‹ä»¶è§¦å‘åå†æ‰§è¡Œã€‚</p>

        <div class="test-section">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="statusDisplay">
                <div class="status waiting">ç­‰å¾…åˆå§‹åŒ–...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ§åˆ¶</h3>
            <button onclick="initializeChatManager()">åˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨</button>
            <button onclick="simulateOperatorStatus()">æ¨¡æ‹Ÿ chat.operator.status äº‹ä»¶</button>
            <button onclick="simulateOperatorListChange()">æ¨¡æ‹Ÿ chat.operatorList.change äº‹ä»¶</button>
            <button onclick="simulateSequentialEvents()">æ¨¡æ‹Ÿé¡ºåºäº‹ä»¶ï¼ˆå…ˆ operatorList.changeï¼Œå operator.statusï¼‰</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>äº‹ä»¶æ—¥å¿—</h3>
            <div id="eventLog" class="log"></div>
        </div>

        <div class="test-section">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <button onclick="checkManagerState()">æ£€æŸ¥ç®¡ç†å™¨çŠ¶æ€</button>
            <button onclick="checkPendingOperatorChange()">æ£€æŸ¥å¾…å¤„ç†çš„åº§å¸­å˜åŒ–</button>
            <div id="debugInfo" class="log"></div>
        </div>
    </div>

    <script>
        let chatManager = null;
        let mockQuickEmitter = null;

        // æ¨¡æ‹Ÿ QuickChat API
        function setupMockAPI() {
            // åˆ›å»ºæ¨¡æ‹Ÿçš„äº‹ä»¶å‘å°„å™¨
            mockQuickEmitter = {
                events: {},
                on: function(eventName, callback) {
                    if (!this.events[eventName]) {
                        this.events[eventName] = [];
                    }
                    this.events[eventName].push(callback);
                    log(`ğŸ“ æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨: ${eventName}`);
                },
                emit: function(eventName, data) {
                    log(`ğŸš€ è§¦å‘äº‹ä»¶: ${eventName}`, data);
                    if (this.events[eventName]) {
                        this.events[eventName].forEach(callback => {
                            try {
                                callback(data);
                            } catch (error) {
                                log(`âŒ äº‹ä»¶å¤„ç†å‡ºé”™: ${error.message}`);
                            }
                        });
                    }
                }
            };

            // è®¾ç½®å…¨å±€å¯¹è±¡
            window.quickEmitter = mockQuickEmitter;
            window.quickChatApi = {
                emitGetAllOperatorStatus: function(ids) {
                    log(`ğŸ“¡ è°ƒç”¨ emitGetAllOperatorStatus:`, ids);
                },
                customHeader: {
                    mount: function(callback) {
                        log(`ğŸ”§ æŒ‚è½½å¤´éƒ¨ç»„ä»¶`);
                        const mockContainer = document.createElement('div');
                        mockContainer.id = 'mock-header';
                        callback(mockContainer);
                    }
                },
                customLeftBar: {
                    mount: function(callback) {
                        log(`ğŸ”§ æŒ‚è½½å·¦ä¾§æ ç»„ä»¶`);
                        const mockContainer = document.createElement('div');
                        mockContainer.id = 'mock-leftbar';
                        callback(mockContainer);
                    },
                    setIsShow: function(show) {
                        log(`ğŸ‘ï¸ è®¾ç½®å·¦ä¾§æ æ˜¾ç¤º: ${show}`);
                    }
                },
                customFooter: {
                    mount: function(callback) {
                        log(`ğŸ”§ æŒ‚è½½åº•éƒ¨ç»„ä»¶`);
                        const mockContainer = document.createElement('div');
                        mockContainer.id = 'mock-footer';
                        callback(mockContainer);
                    }
                }
            };

            log(`âœ… æ¨¡æ‹Ÿ API è®¾ç½®å®Œæˆ`);
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLog');
            const logEntry = document.createElement('div');
            
            let logText = `[${timestamp}] ${message}`;
            if (data) {
                logText += ` | æ•°æ®: ${JSON.stringify(data)}`;
            }
            
            logEntry.textContent = logText;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message, data);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, message) {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.innerHTML = `<div class="status ${status}">${message}</div>`;
        }

        // åˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨
        async function initializeChatManager() {
            try {
                log(`ğŸš€ å¼€å§‹åˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨`);
                updateStatus('processing', 'æ­£åœ¨åˆå§‹åŒ–...');

                // è®¾ç½®æ¨¡æ‹Ÿ API
                setupMockAPI();

                // æ¨¡æ‹Ÿå®¢æœæ•°æ®
                const mockCustomerServiceData = [
                    {
                        quickCepId: 'agent001',
                        employeeEnName: 'Alice',
                        status: 2,
                        isOnline: true
                    },
                    {
                        quickCepId: 'agent002', 
                        employeeEnName: 'Bob',
                        status: 1,
                        isOnline: false
                    }
                ];

                // åŠ¨æ€å¯¼å…¥ ChatManagerï¼ˆåœ¨å®é™…ç¯å¢ƒä¸­ï¼‰
                // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªç®€åŒ–çš„ ChatManager
                chatManager = {
                    operatorStatusReceived: false,
                    pendingOperatorListChange: null,
                    
                    init: async function() {
                        log(`ğŸ“‹ ChatManager åˆå§‹åŒ–ä¸­...`);
                        this.setupEventListeners();
                        log(`âœ… ChatManager åˆå§‹åŒ–å®Œæˆ`);
                    },
                    
                    setupEventListeners: function() {
                        // ç›‘å¬å®¢æœçŠ¶æ€æ›´æ–°
                        window.quickEmitter.on('chat.operator.status', (data) => {
                            log(`ğŸ“Š æ¥æ”¶åˆ° chat.operator.status äº‹ä»¶`);
                            this.operatorStatusReceived = true;
                            updateStatus('ready', 'å·²æ¥æ”¶åˆ°å®¢æœçŠ¶æ€æ•°æ®');
                            
                            // å¦‚æœæœ‰å¾…å¤„ç†çš„åº§å¸­åˆ—è¡¨å˜åŒ–ï¼Œç°åœ¨å¤„ç†å®ƒ
                            if (this.pendingOperatorListChange) {
                                log(`â³ å¤„ç†å¾…å¤„ç†çš„åº§å¸­åˆ—è¡¨å˜åŒ–`);
                                this.handleOperatorListChange(this.pendingOperatorListChange);
                                this.pendingOperatorListChange = null;
                            }
                        });

                        // ç›‘å¬å½“å‰ä¼šè¯åº§å¸­å˜åŒ–
                        window.quickEmitter.on('chat.operatorList.change', (data) => {
                            log(`ğŸ‘¥ æ¥æ”¶åˆ° chat.operatorList.change äº‹ä»¶`);
                            
                            // æ£€æŸ¥æ˜¯å¦å·²æ¥æ”¶åˆ°å®¢æœçŠ¶æ€æ•°æ®
                            if (this.operatorStatusReceived) {
                                log(`âœ… å®¢æœçŠ¶æ€å·²å°±ç»ªï¼Œç«‹å³å¤„ç†åº§å¸­åˆ—è¡¨å˜åŒ–`);
                                this.handleOperatorListChange(data);
                            } else {
                                log(`â¸ï¸ å®¢æœçŠ¶æ€æœªå°±ç»ªï¼Œæš‚å­˜åº§å¸­åˆ—è¡¨å˜åŒ–ç­‰å¾…å¤„ç†`);
                                updateStatus('waiting', 'ç­‰å¾…å®¢æœçŠ¶æ€æ•°æ®...');
                                this.pendingOperatorListChange = data;
                            }
                        });
                    },
                    
                    handleOperatorListChange: function(data) {
                        log(`ğŸ”„ å¼€å§‹å¤„ç†åº§å¸­åˆ—è¡¨å˜åŒ–`, data);
                        updateStatus('processing', 'æ­£åœ¨å¤„ç†åº§å¸­åˆ—è¡¨å˜åŒ–...');
                        
                        // æ¨¡æ‹Ÿå¤„ç†é€»è¾‘
                        setTimeout(() => {
                            log(`âœ… åº§å¸­åˆ—è¡¨å˜åŒ–å¤„ç†å®Œæˆ`);
                            updateStatus('ready', 'åº§å¸­åˆ—è¡¨å˜åŒ–å¤„ç†å®Œæˆ');
                        }, 500);
                    }
                };

                await chatManager.init();
                updateStatus('ready', 'èŠå¤©ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                log(`âœ… èŠå¤©ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ`);

            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                updateStatus('waiting', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // æ¨¡æ‹Ÿ chat.operator.status äº‹ä»¶
        function simulateOperatorStatus() {
            if (!mockQuickEmitter) {
                log(`âŒ è¯·å…ˆåˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨`);
                return;
            }

            const mockStatusData = {
                operatorUserIdStatus: {
                    'agent001': 2, // åœ¨çº¿ç©ºé—²
                    'agent002': 1  // ç¦»çº¿
                }
            };

            log(`ğŸ­ æ¨¡æ‹Ÿè§¦å‘ chat.operator.status äº‹ä»¶`);
            mockQuickEmitter.emit('chat.operator.status', mockStatusData);
        }

        // æ¨¡æ‹Ÿ chat.operatorList.change äº‹ä»¶
        function simulateOperatorListChange() {
            if (!mockQuickEmitter) {
                log(`âŒ è¯·å…ˆåˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨`);
                return;
            }

            const mockOperatorData = [
                {
                    operatorId: 'agent001',
                    onlineStatus: 2
                }
            ];

            log(`ğŸ­ æ¨¡æ‹Ÿè§¦å‘ chat.operatorList.change äº‹ä»¶`);
            mockQuickEmitter.emit('chat.operatorList.change', mockOperatorData);
        }

        // æ¨¡æ‹Ÿé¡ºåºäº‹ä»¶ï¼ˆå…ˆ operatorList.changeï¼Œå operator.statusï¼‰
        function simulateSequentialEvents() {
            if (!mockQuickEmitter) {
                log(`âŒ è¯·å…ˆåˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨`);
                return;
            }

            log(`ğŸ¬ å¼€å§‹æ¨¡æ‹Ÿé¡ºåºäº‹ä»¶æµ‹è¯•`);
            
            // å…ˆè§¦å‘ operatorList.changeï¼ˆåº”è¯¥è¢«æš‚å­˜ï¼‰
            setTimeout(() => {
                simulateOperatorListChange();
            }, 100);

            // å†è§¦å‘ operator.statusï¼ˆåº”è¯¥å¤„ç†æš‚å­˜çš„ operatorList.changeï¼‰
            setTimeout(() => {
                simulateOperatorStatus();
            }, 2000);
        }

        // æ£€æŸ¥ç®¡ç†å™¨çŠ¶æ€
        function checkManagerState() {
            if (!chatManager) {
                updateDebugInfo('âŒ èŠå¤©ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }

            const state = {
                operatorStatusReceived: chatManager.operatorStatusReceived,
                hasPendingOperatorChange: !!chatManager.pendingOperatorListChange,
                pendingData: chatManager.pendingOperatorListChange
            };

            updateDebugInfo(`ç®¡ç†å™¨çŠ¶æ€: ${JSON.stringify(state, null, 2)}`);
        }

        // æ£€æŸ¥å¾…å¤„ç†çš„åº§å¸­å˜åŒ–
        function checkPendingOperatorChange() {
            if (!chatManager) {
                updateDebugInfo('âŒ èŠå¤©ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }

            if (chatManager.pendingOperatorListChange) {
                updateDebugInfo(`å¾…å¤„ç†çš„åº§å¸­å˜åŒ–: ${JSON.stringify(chatManager.pendingOperatorListChange, null, 2)}`);
            } else {
                updateDebugInfo('æ²¡æœ‰å¾…å¤„ç†çš„åº§å¸­å˜åŒ–');
            }
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo(info) {
            const debugElement = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML = `[${timestamp}] ${info}`;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
            document.getElementById('debugInfo').innerHTML = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log(`ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•`);
            updateStatus('waiting', 'ç‚¹å‡»"åˆå§‹åŒ–èŠå¤©ç®¡ç†å™¨"å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>