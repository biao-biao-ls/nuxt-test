<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记住客服选择功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #545b62;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        .status-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .status-section {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            background-color: #f8f9fa;
        }
        .status-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .agent-list {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .agent-item {
            margin: 5px 0;
            padding: 8px;
            background-color: white;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .agent-item:hover {
            background-color: #e3f2fd;
        }
        .agent-item.current {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .agent-item.stored {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .status-online {
            color: #28a745;
            font-weight: bold;
        }
        .status-offline {
            color: #dc3545;
            font-weight: bold;
        }
        .feature-explanation {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .feature-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #0c5460;
        }
        .step-list {
            list-style-type: decimal;
            padding-left: 20px;
        }
        .step-list li {
            margin: 8px 0;
            line-height: 1.4;
        }
        .log-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-entry.info {
            color: #0c5460;
        }
        .log-entry.success {
            color: #155724;
        }
        .log-entry.warning {
            color: #856404;
        }
        .log-entry.error {
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">记住客服选择功能测试</div>
        <div class="test-description">
            测试页面刷新后自动恢复之前选择的客服功能。当选择客服后，信息会保存到本地存储，页面刷新时会自动恢复（如果该客服仍在线）。
        </div>

        <div class="feature-explanation">
            <div class="feature-title">功能说明：</div>
            <ol class="step-list">
                <li>选择一个在线客服，系统会自动保存到本地存储</li>
                <li>刷新页面，系统会检查之前选择的客服是否仍在线</li>
                <li>如果客服仍在线，自动恢复选择；如果离线，则不恢复</li>
                <li>客服离线时会自动清除本地存储的选择</li>
                <li>本地存储的数据有24小时的有效期</li>
            </ol>
        </div>

        <div class="agent-list" id="agentList">
            <div class="test-title" style="font-size: 14px; margin-bottom: 10px;">客服列表：</div>
        </div>

        <div class="controls">
            <button onclick="selectRandomAgent()" class="success">随机选择客服</button>
            <button onclick="clearCurrentAgent()" class="secondary">清除当前选择</button>
            <button onclick="toggleAgentStatus()" class="secondary">切换客服状态</button>
            <button onclick="simulateRefresh()" class="primary">模拟页面刷新</button>
            <button onclick="viewStoredData()" class="secondary">查看存储数据</button>
            <button onclick="clearStoredData()" class="danger">清除存储数据</button>
        </div>

        <div class="status-display">
            <div class="status-section">
                <h4>当前状态</h4>
                <div id="currentStatus">无客服选择</div>
            </div>
            <div class="status-section">
                <h4>本地存储</h4>
                <div id="storageStatus">无存储数据</div>
            </div>
        </div>

        <div class="log-area" id="logArea">
            <div class="log-entry info">测试日志将显示在这里...</div>
        </div>
    </div>

    <script>
        // 模拟客服数据
        const mockAgents = [
            { employeeEnName: "test_01", quickCepId: "1938524999731687426", isOnline: true, businessLine: "3D Printing" },
            { employeeEnName: "caocao", quickCepId: "1942407035945005058", isOnline: true, businessLine: "3D Printing" },
            { employeeEnName: "xiaozhou", quickCepId: "1938144757068906498", isOnline: false, businessLine: "PCB Assembly" },
            { employeeEnName: "Alex", quickCepId: "1946056607741292545", isOnline: true, businessLine: "SMT Services" },
            { employeeEnName: "yxy", quickCepId: "1938475369237098497", isOnline: false, businessLine: "SMT Services" },
            { employeeEnName: "Ryan", quickCepId: "1942107108466016257", isOnline: true, businessLine: "Components" }
        ];

        let currentAgent = null;
        const storageKey = "quickchat_selected_agent";

        // 日志功能
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 保存选择的客服到本地存储
        function saveSelectedAgent(agent) {
            try {
                if (agent) {
                    const agentData = {
                        quickCepId: agent.quickCepId,
                        employeeEnName: agent.employeeEnName,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(storageKey, JSON.stringify(agentData));
                    addLog(`已保存客服选择: ${agent.employeeEnName}`, 'success');
                } else {
                    localStorage.removeItem(storageKey);
                    addLog('已清除客服选择存储', 'info');
                }
                updateStorageStatus();
            } catch (error) {
                addLog(`保存失败: ${error.message}`, 'error');
            }
        }

        // 从本地存储获取客服选择
        function getStoredSelectedAgent() {
            try {
                const storedData = localStorage.getItem(storageKey);
                if (storedData) {
                    const agentData = JSON.parse(storedData);
                    // 检查是否在24小时内
                    const maxAge = 24 * 60 * 60 * 1000;
                    if (Date.now() - agentData.timestamp < maxAge) {
                        return agentData;
                    } else {
                        localStorage.removeItem(storageKey);
                        addLog('存储数据已过期，已清除', 'warning');
                    }
                }
            } catch (error) {
                addLog(`获取存储数据失败: ${error.message}`, 'error');
            }
            return null;
        }

        // 尝试恢复之前选择的客服
        function restorePreviousSelectedAgent() {
            const storedAgent = getStoredSelectedAgent();
            if (!storedAgent) {
                addLog('没有找到之前的客服选择记录', 'info');
                return false;
            }

            addLog(`尝试恢复客服: ${storedAgent.employeeEnName}`, 'info');

            const agent = mockAgents.find(a => a.quickCepId === storedAgent.quickCepId);
            if (!agent) {
                addLog(`客服 ${storedAgent.employeeEnName} 不存在`, 'warning');
                saveSelectedAgent(null);
                return false;
            }

            if (!agent.isOnline) {
                addLog(`客服 ${storedAgent.employeeEnName} 当前离线，无法恢复`, 'warning');
                return false;
            }

            currentAgent = agent;
            addLog(`成功恢复客服选择: ${agent.employeeEnName}`, 'success');
            updateDisplay();
            return true;
        }

        // 选择客服
        function selectAgent(agent) {
            if (!agent.isOnline) {
                addLog(`客服 ${agent.employeeEnName} 离线，无法选择`, 'warning');
                return;
            }

            currentAgent = agent;
            saveSelectedAgent(agent);
            addLog(`选择客服: ${agent.employeeEnName}`, 'success');
            updateDisplay();
        }

        // 更新显示
        function updateDisplay() {
            updateAgentList();
            updateCurrentStatus();
            updateStorageStatus();
        }

        // 更新客服列表
        function updateAgentList() {
            const listDiv = document.getElementById('agentList');
            const storedAgent = getStoredSelectedAgent();
            
            let html = '<div class="test-title" style="font-size: 14px; margin-bottom: 10px;">客服列表：</div>';
            
            mockAgents.forEach(agent => {
                const statusClass = agent.isOnline ? 'status-online' : 'status-offline';
                const statusText = agent.isOnline ? '在线' : '离线';
                let itemClass = 'agent-item';
                
                if (currentAgent && currentAgent.quickCepId === agent.quickCepId) {
                    itemClass += ' current';
                } else if (storedAgent && storedAgent.quickCepId === agent.quickCepId) {
                    itemClass += ' stored';
                }
                
                html += `
                    <div class="${itemClass}" onclick="selectAgent(mockAgents.find(a => a.quickCepId === '${agent.quickCepId}'))">
                        <span>${agent.employeeEnName} (${agent.businessLine})</span>
                        <span class="${statusClass}">${statusText}</span>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        // 更新当前状态
        function updateCurrentStatus() {
            const statusDiv = document.getElementById('currentStatus');
            if (currentAgent) {
                statusDiv.innerHTML = `当前选择: <strong>${currentAgent.employeeEnName}</strong><br>状态: ${currentAgent.isOnline ? '在线' : '离线'}`;
            } else {
                statusDiv.innerHTML = '无客服选择';
            }
        }

        // 更新存储状态
        function updateStorageStatus() {
            const statusDiv = document.getElementById('storageStatus');
            const storedAgent = getStoredSelectedAgent();
            if (storedAgent) {
                const date = new Date(storedAgent.timestamp);
                statusDiv.innerHTML = `存储客服: <strong>${storedAgent.employeeEnName}</strong><br>时间: ${date.toLocaleString()}`;
            } else {
                statusDiv.innerHTML = '无存储数据';
            }
        }

        // 测试功能
        function selectRandomAgent() {
            const onlineAgents = mockAgents.filter(agent => agent.isOnline);
            if (onlineAgents.length > 0) {
                const randomAgent = onlineAgents[Math.floor(Math.random() * onlineAgents.length)];
                selectAgent(randomAgent);
            } else {
                addLog('没有在线客服可选择', 'warning');
            }
        }

        function clearCurrentAgent() {
            currentAgent = null;
            saveSelectedAgent(null);
            addLog('已清除当前客服选择', 'info');
            updateDisplay();
        }

        function toggleAgentStatus() {
            mockAgents.forEach(agent => {
                agent.isOnline = Math.random() > 0.5;
            });
            
            // 检查当前选择的客服是否离线
            if (currentAgent && !currentAgent.isOnline) {
                addLog(`当前客服 ${currentAgent.employeeEnName} 已离线，清除选择`, 'warning');
                currentAgent = null;
                saveSelectedAgent(null);
            }
            
            addLog('已随机切换客服在线状态', 'info');
            updateDisplay();
        }

        function simulateRefresh() {
            addLog('=== 模拟页面刷新 ===', 'info');
            currentAgent = null;
            updateCurrentStatus();
            
            setTimeout(() => {
                const restored = restorePreviousSelectedAgent();
                if (!restored) {
                    addLog('页面刷新后无法恢复客服选择', 'info');
                }
                addLog('=== 刷新完成 ===', 'info');
            }, 500);
        }

        function viewStoredData() {
            const storedAgent = getStoredSelectedAgent();
            if (storedAgent) {
                addLog(`存储数据: ${JSON.stringify(storedAgent)}`, 'info');
            } else {
                addLog('没有存储数据', 'info');
            }
        }

        function clearStoredData() {
            localStorage.removeItem(storageKey);
            addLog('已清除本地存储数据', 'info');
            updateStorageStatus();
        }

        // 页面加载时初始化
        window.addEventListener('load', () => {
            addLog('页面加载完成', 'info');
            updateDisplay();
            
            // 模拟系统初始化后的恢复过程
            setTimeout(() => {
                addLog('开始尝试恢复之前的客服选择...', 'info');
                restorePreviousSelectedAgent();
            }, 1000);
        });
    </script>
</body>
</html>