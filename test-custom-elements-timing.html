<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰å…ƒç´ æ—¶æœºæ§åˆ¶æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button-group {
            margin: 15px 0;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .status-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .log-output {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .iframe-container {
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .iframe-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            font-weight: bold;
        }
        .mock-iframe {
            width: 100%;
            height: 400px;
            border: none;
            background-color: white;
        }
        .timing-info {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        .timing-info h4 {
            margin-top: 0;
            color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è‡ªå®šä¹‰å…ƒç´ æ˜¾ç¤ºæ—¶æœºæ§åˆ¶æµ‹è¯•</h1>
        
        <div class="timing-info">
            <h4>ğŸ“‹ æµ‹è¯•è¯´æ˜</h4>
            <p>æœ¬æµ‹è¯•éªŒè¯è‡ªå®šä¹‰åŒºåŸŸå…ƒç´ çš„æ˜¾ç¤ºæ—¶æœºæ§åˆ¶é€»è¾‘ï¼š</p>
            <ul>
                <li><strong>åˆå§‹çŠ¶æ€</strong>ï¼šåªæ˜¾ç¤º .current-agent å…ƒç´ </li>
                <li><strong>ç­‰å¾…æ—¶æœº</strong>ï¼šç›‘å¬ iframe ä¸­çš„ #chat-body-content .visitor-message å…ƒç´ </li>
                <li><strong>å®Œæ•´åˆå§‹åŒ–</strong>ï¼šå½“æ£€æµ‹åˆ°ç›®æ ‡å…ƒç´ æ—¶ï¼Œåˆå§‹åŒ–æ‰€æœ‰è‡ªå®šä¹‰åŒºåŸŸ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
                <button class="btn btn-info" onclick="checkChatWindow()">æ£€æŸ¥èŠå¤©çª—å£</button>
                <button class="btn btn-success" onclick="initializeElements()">æ‰‹åŠ¨åˆå§‹åŒ–å…ƒç´ </button>
                <button class="btn btn-warning" onclick="restartMonitoring()">é‡æ–°å¼€å§‹ç›‘å¬</button>
            </div>
            <div id="systemStatus" class="status-display">ç‚¹å‡»"æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"æŸ¥çœ‹å½“å‰çŠ¶æ€...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” èŠå¤©çª—å£æ¨¡æ‹Ÿ</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="simulateIframeLoad()">æ¨¡æ‹Ÿ iframe åŠ è½½</button>
                <button class="btn btn-success" onclick="simulateVisitorMessage()">æ¨¡æ‹Ÿè®¿å®¢æ¶ˆæ¯å‡ºç°</button>
                <button class="btn btn-warning" onclick="clearMockIframe()">æ¸…ç©ºæ¨¡æ‹Ÿçª—å£</button>
            </div>
            
            <div class="iframe-container">
                <div class="iframe-header">æ¨¡æ‹Ÿ QuickChat iframe (id: quick-chat-iframe)</div>
                <iframe id="quick-chat-iframe" class="mock-iframe" srcdoc="
                    <div style='padding: 20px; font-family: Arial, sans-serif;'>
                        <h3>QuickChat èŠå¤©çª—å£æ¨¡æ‹Ÿ</h3>
                        <div id='chat-body-content' style='border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: #f9f9f9;'>
                            <p>èŠå¤©å†…å®¹åŒºåŸŸ</p>
                            <div style='margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 4px;'>
                                ç­‰å¾…è®¿å®¢æ¶ˆæ¯...
                            </div>
                        </div>
                    </div>
                "></iframe>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª è‡ªå®šä¹‰å…ƒç´ æµ‹è¯•</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testHeaderElements()">æµ‹è¯•å¤´éƒ¨å…ƒç´ </button>
                <button class="btn btn-success" onclick="testLeftBarElements()">æµ‹è¯•å·¦ä¾§æ å…ƒç´ </button>
                <button class="btn btn-info" onclick="testFooterElements()">æµ‹è¯•åº•éƒ¨å…ƒç´ </button>
                <button class="btn btn-warning" onclick="refreshAllUI()">åˆ·æ–°æ‰€æœ‰UI</button>
            </div>
            <div id="elementsStatus" class="status-display">ç‚¹å‡»ç›¸åº”æŒ‰é’®æµ‹è¯•è‡ªå®šä¹‰å…ƒç´ ...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
            <div class="button-group">
                <button class="btn btn-info" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn btn-warning" onclick="toggleAutoScroll()">åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
            </div>
            <div id="logOutput" class="log-output">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
        </div>
    </div>

    <script>
        let autoScroll = true;
        let logContainer;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logOutput');
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•...');
            
            // æ¨¡æ‹Ÿ QuickChat ç¯å¢ƒ
            setupMockQuickChat();
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (logContainer) {
                logContainer.textContent += logMessage + '\n';
                if (autoScroll) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }
            console.log(logMessage);
        }

        // è®¾ç½®æ¨¡æ‹Ÿ QuickChat ç¯å¢ƒ
        function setupMockQuickChat() {
            log('è®¾ç½®æ¨¡æ‹Ÿ QuickChat ç¯å¢ƒ...');
            
            // æ¨¡æ‹Ÿ QuickChat API
            window.quickChatApi = {
                customHeader: {
                    mount: function(callback) {
                        log('customHeader.mount è¢«è°ƒç”¨');
                        const container = document.createElement('div');
                        container.id = 'mock-header-container';
                        container.style.cssText = 'border: 2px solid #28a745; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    }
                },
                customLeftBar: {
                    mount: function(callback) {
                        log('customLeftBar.mount è¢«è°ƒç”¨');
                        const container = document.createElement('div');
                        container.id = 'mock-leftbar-container';
                        container.style.cssText = 'border: 2px solid #17a2b8; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    },
                    setIsShow: function(show) {
                        log(`customLeftBar.setIsShow(${show}) è¢«è°ƒç”¨`);
                        const container = document.getElementById('mock-leftbar-container');
                        if (container) {
                            container.style.display = show ? 'block' : 'none';
                        }
                    }
                },
                customFooter: {
                    mount: function(callback) {
                        log('customFooter.mount è¢«è°ƒç”¨');
                        const container = document.createElement('div');
                        container.id = 'mock-footer-container';
                        container.style.cssText = 'border: 2px solid #ffc107; padding: 10px; margin: 10px 0; background: #f8f9fa;';
                        document.body.appendChild(container);
                        callback(container);
                    }
                },
                emitGetAllOperatorStatus: function(ids) {
                    log(`emitGetAllOperatorStatus è¢«è°ƒç”¨ï¼Œå®¢æœIDs: ${JSON.stringify(ids)}`);
                },
                switchChat: function(id) {
                    log(`switchChat è¢«è°ƒç”¨ï¼Œå®¢æœID: ${id}`);
                }
            };

            window.quickEmitter = {
                on: function(event, callback) {
                    log(`ç›‘å¬äº‹ä»¶: ${event}`);
                },
                off: function(event) {
                    log(`å–æ¶ˆç›‘å¬äº‹ä»¶: ${event}`);
                },
                emit: function(event, data) {
                    log(`è§¦å‘äº‹ä»¶: ${event}, æ•°æ®: ${JSON.stringify(data)}`);
                }
            };

            // æ¨¡æ‹Ÿ QuickChat åˆå§‹åŒ–
            setTimeout(() => {
                log('æ¨¡æ‹Ÿ QuickChat åˆå§‹åŒ–å®Œæˆ');
                if (window.quickChatReadyHook) {
                    window.quickChatReadyHook();
                }
            }, 1000);
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        function checkSystemStatus() {
            log('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            const status = {
                quickChatApi: !!window.quickChatApi,
                quickEmitter: !!window.quickEmitter,
                chatManager: !!window.chatManager,
                chatUI: !!window.chatUI,
                debugQuickChat: !!window.debugQuickChat
            };

            const statusText = Object.entries(status)
                .map(([key, value]) => `${key}: ${value ? 'âœ…' : 'âŒ'}`)
                .join('\n');

            document.getElementById('systemStatus').textContent = statusText;
            log('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ');

            if (window.debugQuickChat && window.debugQuickChat.getSystemStatus) {
                const detailedStatus = window.debugQuickChat.getSystemStatus();
                log(`è¯¦ç»†çŠ¶æ€: ${JSON.stringify(detailedStatus, null, 2)}`);
            }
        }

        // æ£€æŸ¥èŠå¤©çª—å£
        function checkChatWindow() {
            log('æ£€æŸ¥èŠå¤©çª—å£çŠ¶æ€...');
            
            if (window.debugQuickChat && window.debugQuickChat.checkChatWindow) {
                const result = window.debugQuickChat.checkChatWindow();
                log(`èŠå¤©çª—å£æ£€æŸ¥ç»“æœ: ${result}`);
            } else {
                log('debugQuickChat.checkChatWindow æ–¹æ³•ä¸å¯ç”¨');
            }
        }

        // æ‰‹åŠ¨åˆå§‹åŒ–å…ƒç´ 
        function initializeElements() {
            log('æ‰‹åŠ¨åˆå§‹åŒ–è‡ªå®šä¹‰å…ƒç´ ...');
            
            if (window.debugQuickChat && window.debugQuickChat.initializeCustomElements) {
                window.debugQuickChat.initializeCustomElements();
                log('è‡ªå®šä¹‰å…ƒç´ åˆå§‹åŒ–å®Œæˆ');
            } else {
                log('debugQuickChat.initializeCustomElements æ–¹æ³•ä¸å¯ç”¨');
            }
        }

        // é‡æ–°å¼€å§‹ç›‘å¬
        function restartMonitoring() {
            log('é‡æ–°å¼€å§‹ç›‘å¬èŠå¤©çª—å£...');
            
            if (window.debugQuickChat && window.debugQuickChat.restartMonitoring) {
                window.debugQuickChat.restartMonitoring();
                log('ç›‘å¬å·²é‡æ–°å¼€å§‹');
            } else {
                log('debugQuickChat.restartMonitoring æ–¹æ³•ä¸å¯ç”¨');
            }
        }

        // æ¨¡æ‹Ÿ iframe åŠ è½½
        function simulateIframeLoad() {
            log('æ¨¡æ‹Ÿ iframe åŠ è½½...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (iframe) {
                // è§¦å‘ load äº‹ä»¶
                const event = new Event('load');
                iframe.dispatchEvent(event);
                log('iframe load äº‹ä»¶å·²è§¦å‘');
            }
        }

        // æ¨¡æ‹Ÿè®¿å®¢æ¶ˆæ¯å‡ºç°
        function simulateVisitorMessage() {
            log('æ¨¡æ‹Ÿè®¿å®¢æ¶ˆæ¯å‡ºç°...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (iframe && iframe.contentDocument) {
                const chatBodyContent = iframe.contentDocument.getElementById('chat-body-content');
                if (chatBodyContent) {
                    // æ·»åŠ è®¿å®¢æ¶ˆæ¯å…ƒç´ 
                    const visitorMessage = iframe.contentDocument.createElement('div');
                    visitorMessage.className = 'visitor-message';
                    visitorMessage.style.cssText = 'padding: 10px; margin: 5px 0; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;';
                    visitorMessage.textContent = 'è¿™æ˜¯ä¸€æ¡æ¨¡æ‹Ÿçš„è®¿å®¢æ¶ˆæ¯';
                    
                    chatBodyContent.appendChild(visitorMessage);
                    log('è®¿å®¢æ¶ˆæ¯å…ƒç´ å·²æ·»åŠ åˆ° iframe');
                    
                    // æ£€æŸ¥æ˜¯å¦è§¦å‘äº†è‡ªå®šä¹‰å…ƒç´ åˆå§‹åŒ–
                    setTimeout(() => {
                        checkChatWindow();
                    }, 500);
                } else {
                    log('æœªæ‰¾åˆ° #chat-body-content å…ƒç´ ');
                }
            } else {
                log('æ— æ³•è®¿é—® iframe å†…å®¹');
            }
        }

        // æ¸…ç©ºæ¨¡æ‹Ÿçª—å£
        function clearMockIframe() {
            log('æ¸…ç©ºæ¨¡æ‹ŸèŠå¤©çª—å£...');
            
            const iframe = document.getElementById('quick-chat-iframe');
            if (iframe && iframe.contentDocument) {
                const chatBodyContent = iframe.contentDocument.getElementById('chat-body-content');
                if (chatBodyContent) {
                    // ç§»é™¤æ‰€æœ‰è®¿å®¢æ¶ˆæ¯
                    const visitorMessages = chatBodyContent.querySelectorAll('.visitor-message');
                    visitorMessages.forEach(msg => msg.remove());
                    log(`å·²ç§»é™¤ ${visitorMessages.length} æ¡è®¿å®¢æ¶ˆæ¯`);
                }
            }
        }

        // æµ‹è¯•å¤´éƒ¨å…ƒç´ 
        function testHeaderElements() {
            log('æµ‹è¯•å¤´éƒ¨å…ƒç´ ...');
            
            const container = document.getElementById('mock-header-container');
            if (container) {
                const elements = {
                    'current-agent': container.querySelector('.current-agent'),
                    'online-agent': container.querySelectorAll('.online-agent'),
                    'open-leftbar-icon': container.querySelector('.open-leftbar-icon')
                };
                
                let status = 'å¤´éƒ¨å…ƒç´ çŠ¶æ€:\n';
                status += `- .current-agent: ${elements['current-agent'] ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
                status += `- .online-agent: ${elements['online-agent'].length} ä¸ª\n`;
                status += `- .open-leftbar-icon: ${elements['open-leftbar-icon'] ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`;
                
                document.getElementById('elementsStatus').textContent = status;
                log('å¤´éƒ¨å…ƒç´ æ£€æŸ¥å®Œæˆ');
            } else {
                log('å¤´éƒ¨å®¹å™¨ä¸å­˜åœ¨');
            }
        }

        // æµ‹è¯•å·¦ä¾§æ å…ƒç´ 
        function testLeftBarElements() {
            log('æµ‹è¯•å·¦ä¾§æ å…ƒç´ ...');
            
            const container = document.getElementById('mock-leftbar-container');
            if (container) {
                const elements = {
                    'left-bar': container.querySelector('.left-bar'),
                    'agent-item': container.querySelectorAll('.agent-item'),
                    'business-line-group': container.querySelectorAll('.business-line-group')
                };
                
                let status = 'å·¦ä¾§æ å…ƒç´ çŠ¶æ€:\n';
                status += `- .left-bar: ${elements['left-bar'] ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
                status += `- .agent-item: ${elements['agent-item'].length} ä¸ª\n`;
                status += `- .business-line-group: ${elements['business-line-group'].length} ä¸ª`;
                
                document.getElementById('elementsStatus').textContent = status;
                log('å·¦ä¾§æ å…ƒç´ æ£€æŸ¥å®Œæˆ');
            } else {
                log('å·¦ä¾§æ å®¹å™¨ä¸å­˜åœ¨');
            }
        }

        // æµ‹è¯•åº•éƒ¨å…ƒç´ 
        function testFooterElements() {
            log('æµ‹è¯•åº•éƒ¨å…ƒç´ ...');
            
            const container = document.getElementById('mock-footer-container');
            if (container) {
                const elements = {
                    'chat-footer': container.querySelector('.chat-footer')
                };
                
                let status = 'åº•éƒ¨å…ƒç´ çŠ¶æ€:\n';
                status += `- .chat-footer: ${elements['chat-footer'] ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`;
                
                document.getElementById('elementsStatus').textContent = status;
                log('åº•éƒ¨å…ƒç´ æ£€æŸ¥å®Œæˆ');
            } else {
                log('åº•éƒ¨å®¹å™¨ä¸å­˜åœ¨');
            }
        }

        // åˆ·æ–°æ‰€æœ‰UI
        function refreshAllUI() {
            log('åˆ·æ–°æ‰€æœ‰UI...');
            
            if (window.debugQuickChat && window.debugQuickChat.refreshUI) {
                window.debugQuickChat.refreshUI();
                log('UIåˆ·æ–°å®Œæˆ');
            } else {
                log('debugQuickChat.refreshUI æ–¹æ³•ä¸å¯ç”¨');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            log(`è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¼€å¯' : 'å…³é—­'}`);
        }
    </script>
</body>
</html>